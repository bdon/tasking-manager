"use strict";!function(){angular.module("taskingManager",["ngRoute","ngFileUpload","ng-showdown","ui.bootstrap","angularMoment","chart.js","ngTagsInput","mentio","720kb.socialshare","pascalprecht.translate","taskingmanager.config"]).factory("configService",["EnvironmentConfig",function(e){return e}]).run(["accountService","authService","userPreferencesService",function(e,t,r){var n=t.getLocalStorageSessionName(),a=JSON.parse(localStorage.getItem(n));a&&(t.setSession(a.sessionToken||"",a.username||""),e.setAccount(a.username)),r.initialise()}]).config(["$routeProvider","$locationProvider","$httpProvider","ChartJsProvider","$translateProvider",function(e,t,r,n,a){a.useStaticFilesLoader({prefix:"locale/",suffix:".json"}),a.preferredLanguage("en"),a.useSanitizeValueStrategy("escape"),r.defaults.headers.common["Cache-Control"]="no-cache",r.defaults.cache=!1,r.defaults.headers.get||(r.defaults.headers.get={}),r.defaults.headers.get["If-Modified-Since"]="0",r.interceptors.push("httpInterceptorService"),n.setOptions({chartColors:["#AC3232","#DCDCDC","#7A7A7A","#595959"]}),showdown.setOption("openLinksInNewWindow",!0),e.when("/",{templateUrl:"app/home/home.html",controller:"homeController",controllerAs:"homeCtrl"}).when("/admin/create-project",{templateUrl:"app/admin/create-project/create-project.html",controller:"createProjectController",controllerAs:"createProjectCtrl",reloadOnSearch:!1}).when("/admin/edit-project/:id",{templateUrl:"app/admin/edit-project/edit-project.html",controller:"editProjectController",controllerAs:"editProjectCtrl"}).when("/about",{templateUrl:"app/about/about.html",controller:"aboutController",controllerAs:"aboutCtrl"}).when("/learn",{templateUrl:"app/learn/learn.html"}).when("/what-is-new",{templateUrl:"app/about/what-is-new.html"}).when("/faq",{templateUrl:"app/about/faq.html"}).when("/contribute",{templateUrl:"app/contribute/contribute.html",controller:"contributeController",controllerAs:"contributeCtrl",reloadOnSearch:!1}).when("/project/:id",{templateUrl:"app/project/project.html",controller:"projectController",controllerAs:"projectCtrl",reloadOnSearch:!1}).when("/user/:id",{templateUrl:"app/profile/profile.html",controller:"profileController",controllerAs:"profileCtrl"}).when("/authorized",{templateUrl:"app/login/authorized.html",controller:"authController",controllerAs:"authCtrl"}).when("/auth-failed",{templateUrl:"app/login/auth-failed.html"}).when("/admin/licenses",{templateUrl:"app/admin/licenses/licenses.html",controller:"licensesController",controllerAs:"licensesCtrl"}).when("/admin/licenses/edit/:id",{templateUrl:"app/admin/licenses/license-edit.html",controller:"licenseEditController",controllerAs:"licenseEditCtrl"}).when("/admin/dashboard",{templateUrl:"app/admin/dashboard/dashboard.html",controller:"dashboardController",controllerAs:"dashboardCtrl"}).when("/project/:id/dashboard",{templateUrl:"app/project/project-dashboard.html",controller:"projectDashboardController",controllerAs:"projectDashboardCtrl"}).when("/admin/users",{templateUrl:"app/admin/users/users.html",controller:"usersController",controllerAs:"usersCtrl"}).when("/inbox",{templateUrl:"app/message/inbox.html",controller:"inboxController",controllerAs:"inboxCtrl"}).when("/message/:id",{templateUrl:"app/message/message.html",controller:"messageController",controllerAs:"messageCtrl"}).when("/login",{templateUrl:"app/login/login.html",controller:"loginController",controllerAs:"loginCtrl"}).when("/validate-email",{templateUrl:"app/profile/validate-email.html",controller:"validateEmailController",controllerAs:"validateEmailCtrl",reloadOnSearch:!1}).when("/404",{templateUrl:"app/404/404.html"}).otherwise({redirectTo:"/404"}),t.html5Mode(!0)}])}(),angular.module("taskingmanager.config",[]).constant("EnvironmentConfig",{tmAPI:"/api/v1",layers:[{id:"mapBoxAerial",name:"MapBox Aerial",url:"https://api.mapbox.com/v4/openstreetmap.map-inh7ifmo/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoib3BlbnN0cmVldG1hcCIsImEiOiJhNVlHd29ZIn0.ti6wATGDWOmCnCYen-Ip7Q",type:"XYZ",attribution:"<a href='https://www.mapbox.com/about/maps/' target='_blank'>© Mapbox</a> <a href='http://www.openstreetmap.org/about/' target='_blank'>© OpenStreetMap</a> <a href='https://www.mapbox.com/feedback/#/-74.5/40/10' target='_blank'>Improve this map</a>"},{id:"Population density WMS",name:"Population density",url:"https://sedac.ciesin.columbia.edu/geoserver/wms",layerName:"gpw-v3:gpw-v3-population-density-future-estimates_2005",type:"WMS",attribution:"Source: SEDAC gpw-v3-population-density-future-estimates_2005"},{id:"bing",name:"Bing Imagery",type:"bing",key:"AioPAglzP9Qw32KN17dOkKYRdSlzj7W5kIQY6zct_UCmGc0WRxAh-QeiRBpRUgrv",attribution:"Courtesy of Microsoft Bing",imagerySet:"Aerial"}]}),function(){function e(){this.sponsors=[{name:"The Austrialian Government",logo:"./assets/img/aus-gov-logo-stacked-black.jpg",url:"http://dfat.gov.au"},{name:"USAID GeoCenter and Office of Transition Initiatives",logo:"./assets/img/usaid-logo.png",url:"https://www.usaid.gov"},{name:"World Bank - GFDRR",logo:"./assets/img/gfdrr-logo.png",url:"https://www.gfdrr.org"},{name:"American Red Cross",logo:"./assets/img/americanredcross-logo.png",url:"http://www.redcross.org"},{name:"The George Washington University",logo:"./assets/img/gwu-logo.png",url:"https://www.gwu.edu"},{name:"thinkWhere",logo:"./assets/img/thinkwhere_logo.png",url:"http://www.thinkwhere.com/"},{name:"Development Seed",logo:"./assets/img/ds-logo-pos.svg",url:"https://developmentseed.org/"},{name:"Amazon Web Services",logo:"./assets/img/Powered-by-Amazon-Web-Services.png",url:"https://aws.amazon.com"}]}angular.module("taskingManager").controller("aboutController",[e])}(),function(){function e(){return{scope:{fileread:"="},link:function(e,t){t.bind("change",function(t){var r=new FileReader;r.onload=function(t){e.$apply(function(){e.fileread=t.target.result})},r.readAsText(t.target.files[0])})}}}angular.module("taskingManager").directive("fileread",e)}(),function(){function e(e,t,r,n,a,o,i){function s(e){f.projectStatuses=[],f.mappingTypes=[],f.searchDraft&&f.projectStatuses.push("DRAFT"),f.searchArchived&&f.projectStatuses.push("ARCHIVED"),f.searchRoads&&f.mappingTypes.push("ROADS"),f.searchBuildings&&f.mappingTypes.push("BUILDINGS"),f.searchWaterways&&f.mappingTypes.push("WATERWAYS"),f.searchLanduse&&f.mappingTypes.push("LAND_USE"),f.searchOther&&f.mappingTypes.push("OTHER");var t={};if(f.mapperLevel&&(t.mapperLevel=f.mapperLevel),f.projectStatuses.length>0){t.projectStatuses="";for(var r=0;r<f.projectStatuses.length;r++)t.projectStatuses+=f.projectStatuses[r],r<f.projectStatuses.length-1&&(t.projectStatuses+=",")}if(f.mappingTypes.length>0){t.mappingTypes="";for(var r=0;r<f.mappingTypes.length;r++)t.mappingTypes+=f.mappingTypes[r],r<f.mappingTypes.length-1&&(t.mappingTypes+=",")}f.searchOrganisation&&(t.organisationTag=f.searchOrganisation),f.searchCampaign&&(t.campaignTag=f.searchCampaign),f.searchText&&(t.textSearch=f.searchText),e&&(t.page=e),n.searchProjects(t).then(function(e){f.results=e.results,f.pagination=e.pagination,a.replaceFeatures(e.mapResults),u(t)},function(){u(t),f.results={},a.showProjectsOnMap(f.results)})}function c(){o.getOrganisationTags().then(function(e){f.organisations=e.tags},function(){f.organisations=[]})}function l(){o.getCampaignTags().then(function(e){f.campaigns=e.tags},function(){f.campaigns=[]})}function u(e){t.search("difficulty",e.mapperLevel),t.search("organisation",e.organisationTag),t.search("campaign",e.campaignTag),t.search("statuses",e.projectStatuses),t.search("types",e.mappingTypes),t.search("page",e.page),t.search("text",e.textSearch)}function d(){f.searchOrganisation=t.search().organisation,f.searchCampaign=t.search().campaign,f.currentPage=t.search().page,f.searchText=t.search().text;var e=t.search().statuses;e&&g(e);var r=t.search().types;r&&p(r),t.search().difficulty&&(f.mapperLevel=t.search().difficulty)}function g(e){for(var t=e.split(","),r=0;r<t.length;r++)"DRAFT"===t[r]&&(f.searchDraft=!0),"ARCHIVED"===t[r]&&(f.searchArchived=!0)}function p(e){for(var t=e.split(","),r=0;r<t.length;r++)"ROADS"===t[r]&&(f.searchRoads=!0),"BUILDINGS"===t[r]&&(f.searchBuildings=!0),"WATERWAYS"==t[r]&&(f.searchWaterways=!0),"LAND_USE"===t[r]&&(f.searchLanduse=!0),"OTHER"===t[r]&&(f.searchOther=!0)}var f=this;f.results=[],f.vectorSource=null,f.resultsView="grid",f.organisations=[],f.campaigns=[],f.mapperLevel="ALL",f.searchDraft=!1,f.searchArchived=!1,f.searchRoads=!1,f.searchBuildings=!1,f.searchWaterways=!1,f.searchLanduse=!1,f.searchOther=!1,f.searchOrganisation="",f.searchCampaign="",f.searchText="",f.currentPage=1,f.pagination=null,f.showVectorLegend=!1,f.showClusterLegend=!0,f.characterLimitShortDescription=250;var m=4891.96981025128;e.$watch(function(){return i.getLanguageCode()},function(){d(),s(f.currentPage)},!0),function(){r.createOSMMap("map",!1),f.map=r.getOSMMap(),a.initialise(f.map,m),f.map.on("moveend",function(){f.showVectorLegend=f.map.getView().getResolution()<m,f.showClusterLegend=f.map.getView().getResolution()>=m,e.$apply()}),a.addPopupOverlay(!1,!0),c(),l()}(),f.search=function(e){s(e)}}angular.module("taskingManager").controller("contributeController",["$scope","$location","mapService","searchService","projectMapService","tagService","languageService",e])}(),function(){function e(e){function t(){e.getHomePageStats().then(function(e){r.stats=e,console.log(r.stats),r.mappersOnline=e.mappersOnline,r.tasksMapped=e.tasksMapped,r.totalMappers=e.totalMappers},function(e){})}var r=this;r.mappersOnline=0,r.tasksMapped=0,r.totalMappers=0,function(){t()}()}angular.module("taskingManager").controller("homeController",["statsService",e])}(),function(){function e(e,t,r){var n=this;n.userName="",n.sessionToken="",function(){n.userName=e.search().username,n.sessionToken=e.search().session_token,t.setSession(n.sessionToken,n.userName),r.setAccount(n.userName);var a=e.search().redirect_to;a?e.path(a):e.path("/"),e.search("username",null),e.search("session_token",null),e.search("redirect_to",null),e.search("ng",null)}()}angular.module("taskingManager").controller("authController",["$location","authService","accountService",e])}(),function(){function e(e,t){var r=this;r.redirectURL="",function(){r.redirectURL=e.search().redirect_to}(),r.login=function(){t.login(r.redirectURL)},r.returnToPreviousPage=function(){e.path(r.redirectURL)}}angular.module("taskingManager").controller("loginController",["$location","authService",e])}(),function(){function e(e){function t(){n.errorRetrievingMessages=!1,e.getAllMessages().then(function(e){if(n.messages=e.userMessages,n.messages)for(var t=0;t<n.messages.length;t++)n.messages[t].subject=r(n.messages[t].subject)},function(e){404==e.status?n.messages=[]:(n.messages=[],n.errorRetrievingMessages=!0)})}function r(e){return e?String(e).replace(/<[^>]+>/gm,""):""}var n=this;n.messages=[],n.showDeleteMessageModal=!1,n.errorRetrievingMessages=!1,function(){t()}(),n.setShowDeleteMessageModal=function(e){n.showDeleteMessageModal=e},n.confirmDeleteMessage=function(e){n.messageIdToBeDeleted=e,n.showDeleteMessageModal=!0},n.deleteMessage=function(){n.deleteMessageFail=!1,e.deleteMessage(n.messageIdToBeDeleted).then(function(e){n.showDeleteMessageModal=!1,t()},function(){n.deleteMessageFail=!0})}}angular.module("taskingManager").controller("inboxController",["messageService",e])}(),function(){function e(e,t){function r(){t.getMessage(n.messageId).then(function(e){n.message=e,n.message.message=t.formatUserNamesToLink(n.message.message)},function(){})}var n=this;n.message={},function(){n.messageId=e.id,r(n.messageId)}()}angular.module("taskingManager").controller("messageController",["$routeParams","messageService",e])}(),function(){function e(e,t,r,n,a,o,i,s,c,l){function u(){g(),i.getOSMUserDetails(f.username).then(function(e){f.osmUserDetails=e})}function d(){i.getUserProjects(f.username).then(function(e){f.projects=e.mappedProjects;for(var t=0;t<f.projects.length;t++)o.showProjectOnMap(f.projects[t],f.projects[t].centroid)},function(){f.projects=[]})}function g(){n.getUser(f.username).then(function(e){f.userDetails=e;var t=n.getAccount();t&&(f.currentlyLoggedInUser=t)},function(){})}function p(){l.getSettings().then(function(e){f.mapperLevelIntermediate=e.mapperLevelIntermediate,f.mapperLevelAdvanced=e.mapperLevelAdvanced})}var f=this;f.username="",f.currentlyLoggedInUser=null,f.userDetails=null,f.osmUserDetails=null,f.projects=[],f.map=null,f.highlightSource=null,f.errorSetRole=!1,f.errorSetLevel=!1,f.errorSetContactDetails=!1,f.errorVerificationEmailSent=!1,f.verificationEmailSent=!1,f.contactDetailsForm={},f.editDetails=!1,f.mapperLevelIntermediate=0,f.mapperLevelAdvanced=0,function(){f.username=e.id,u(),a.createOSMMap("map"),f.map=a.getOSMMap(),o.initialise(f.map),o.addPopupOverlay(!0,!0),d(),p()}(),f.setRole=function(e){f.errorSetRole=!1,i.setRole(f.username,e).then(function(e){g()},function(e){f.errorSetRole=!0})},f.setLevel=function(e){f.errorSetLevel=!1,i.setLevel(f.username,e).then(function(e){g()},function(){f.errorSetLevel=!0})},f.setContactDetails=function(){if(f.contactDetailsForm.$valid){f.errorSetContactDetails=!1;var e={emailAddress:f.userDetails.emailAddress,facebookId:f.userDetails.facebookId,linkedinId:f.userDetails.linkedinId,twitterId:f.userDetails.twitterId};i.setContactDetails(e).then(function(e){f.editDetails=!1,f.verificationEmailSent=e.verificationEmailSent,g()},function(){f.editDetails=!1,f.errorSetContactDetails=!0,g()}),f.editDetails=!1}},f.resendVerificationEmail=function(){f.errorVerificationEmailSent=!1,c.resendEmailVerification().then(function(e){f.verificationEmailSent=!0,g()},function(){f.verificationEmailSent=!1,f.errorVerificationEmailSent=!0,g()})},f.viewOverpassTurbo=function(e){var t=s.getFeatureFromGeoJSON(e),n=t.getGeometry().getExtent(),a=s.transformExtentToLatLonArray(n),o='w="'+a[0]+'" s="'+a[1]+'" e="'+a[2]+'" n="'+a[3]+'"',i='<query type="node"><user name="'+f.username+'"/><bbox-query '+o+'/></query><query type="way"><user name="'+f.username+'"/><bbox-query '+o+'/></query><query type="relation"><user name="'+f.username+'"/><bbox-query '+o+"/></query>",c='<osm-script output="json" timeout="25"><union>'+i+'</union><print mode="body"/><recurse type="down"/><print mode="skeleton" order="quadtile"/></osm-script>';r.open("http://overpass-turbo.eu/map.html?Q="+encodeURIComponent(c))}}angular.module("taskingManager").controller("profileController",["$routeParams","$location","$window","accountService","mapService","projectMapService","userService","geospatialService","messageService","settingsService",e])}(),function(){function e(e){var t=this;t.isValidEmail=!1,function(){var r=!1;e.search().is_valid&&(r=e.search().is_valid.toLowerCase()),t.isValidEmail="true"==r,e.search("is_valid",null)}()}angular.module("taskingManager").controller("validateEmailController",["$location",e])}(),function(){function e(e,t,r,n,a){function o(e){a.getProjectStats(e).then(function(e){l.project=e,r.showProjectOnMap(l.project,l.project.aoiCentroid,!1,!0)},function(e){})}function i(e){n.getCommentsForProject(e).then(function(e){l.projectComments=e.comments},function(e){})}function s(e){a.getProjectContributions(e).then(function(e){l.projectContributions=e.userContributions},function(){l.projectContributions=[]})}function c(e,t){a.getProjectActivity(e,t).then(function(e){l.projectActivityPagination=e.pagination,l.projectActivity=e.activity},function(){l.projectActivityPagination=[],l.projectActivity=[]})}var l=this;l.projectId=0,l.project={},l.projectActivityPagination=[],l.projectActivity=[],l.projectContributions=[],l.projectComments=[],function(){l.projectId=e.id,t.createOSMMap("map"),l.map=t.getOSMMap(),o(l.projectId),i(l.projectId),s(l.projectId),c(l.projectId),r.initialise(l.map)}(),l.getLastActivity=function(e){c(l.projectId,e)}}angular.module("taskingManager").controller("projectDashboardController",["$routeParams","mapService","projectMapService","projectService","statsService",e])}(),function(){function e(e,t,r,n,a,o,i,s,c,l,u,d,g,p,f,m,h,v,S,k,y){function j(){return.3*N.map.getSize()[1]}function T(e){N.selectInteraction.getFeatures().clear(),N.selectInteraction.getFeatures().push(e),D(e)}function w(){S.initInteractions(!0,!1,!1,!1,!1,!1),N.source=S.getSource(),N.drawPolygonInteraction=S.getDrawPolygonInteraction(),N.selectInteraction=new ol.interaction.Select({style:l.getSelectedTaskStyle,layers:[N.taskVectorLayer]}),N.map.addInteraction(N.selectInteraction),N.selectInteraction.on("select",function(e){r.$apply(function(){D(e.selected[0])})}),N.drawPolygonInteraction.on("drawstart",function(){S.getSource().clear()}),N.drawPolygonInteraction.on("drawend",function(t){var r=N.selectInteraction.getFeatures();r.clear();var n=t.feature.getGeometry(),a=N.taskVectorLayer.getSource().getFeatures();N.selectedTasksForValidation=[];for(var o=0;o<a.length;o++)if(n.intersectsExtent(a[o].getGeometry().getExtent())){var i=a[o].getProperties().taskStatus;"MAPPED"!==i&&"VALIDATED"!==i||(r.push(a[o]),N.selectedTasksForValidation.push(a[o].getProperties().taskId))}e(function(){N.selectInteraction.setActive(!0),N.drawPolygonInteraction.setActive(!1),S.getSource().clear()},300)})}function I(e){N.errorGetProject=!1,c.getProject(e).then(function(e){if(N.projectData=e,N.userCanMap=N.user&&c.userCanMapProject(N.user.mappingLevel,N.projectData.mapperLevel,N.projectData.enforceMapperLevel),N.userCanValidate=N.user&&c.userCanValidateProject(N.user.role,N.projectData.enforceValidatorRole),F(N.projectData.areaOfInterest),O(N.projectData.priorityAreas),M(N.projectData.tasks,!0),w(),N.lockedByCurrentUserVectorLayer)N.lockedByCurrentUserVectorLayer.getSource().clear();else{var t=new ol.source.Vector;N.lockedByCurrentUserVectorLayer=new ol.layer.Vector({source:t,name:"lockedByCurrentUser",style:l.getLockedByCurrentUserTaskStyle}),N.map.addLayer(N.lockedByCurrentUserVectorLayer)}if(N.highlightVectorLayer)N.highlightVectorLayer.getSource().clear();else{var t=new ol.source.Vector;N.highlightVectorLayer=new ol.layer.Vector({source:t,name:"highlight",style:l.getHighlightedTaskStyle}),N.map.addLayer(N.highlightVectorLayer)}n.search().task&&L(n.search().task)},function(){N.errorGetProject=!0})}function A(e){N.errorGetProject=!1,c.getProject(e).then(function(e){N.projectData=e},function(){N.errorGetProject=!0})}function P(e){N.errorGetProject=!1,c.getProject(e).then(function(e){if(N.projectData=e,M(N.projectData.tasks,!1),N.selectedTaskData){var t=u.getTaskFeatureById(N.taskVectorLayer.getSource().getFeatures(),N.selectedTaskData.taskId);N.selectInteraction.getFeatures().clear(),N.selectInteraction.getFeatures().push(t)}else if(N.multiSelectedTasksData.length>0){var r=N.multiSelectedTasksData.map(function(e){return e.taskId}),n=u.getTaskFeaturesByIds(N.taskVectorLayer.getSource().getFeatures(),r);N.selectInteraction.getFeatures().clear(),n.forEach(function(e){N.selectInteraction.getFeatures().push(e)})}},function(){N.errorGetProject=!0})}function L(e){var t=u.getTaskFeatureById(N.taskVectorLayer.getSource().getFeatures(),e);if(t){T(t);var r=j();N.map.getView().fit(t.getGeometry().getExtent(),{padding:[r,r,r,r]})}}function M(e,t){var r;N.taskVectorLayer?(r=N.taskVectorLayer.getSource(),r.clear()):(r=new ol.source.Vector,N.taskVectorLayer=new ol.layer.Vector({source:r,name:"tasks",style:l.getTaskStyle}),N.map.addLayer(N.taskVectorLayer),N.map.on("pointermove",function(e){var t=N.map.getEventPixel(e.originalEvent),r=N.map.hasFeatureAtPixel(t,{layerFilter:function(e){return e==N.taskVectorLayer}});N.map.getTargetElement().style.cursor=r?"pointer":""}));var n=d.getFeaturesFromGeoJSON(e);r.addFeatures(n);var a=N.projectData.projectId;p.isUserLoggedIn()&&E(a),t&&N.map.getView().fit(r.getExtent())}function C(e){u.getMappedTasksByUser(e).then(function(e){N.mappedTasksPerUser=e.mappedTasks},function(){N.mappedTasksPerUser=[]})}function E(e){u.getLockedTasksForCurrentUser(e).then(function(e){if(N.lockedTasksForCurrentUser=e,N.lockedByCurrentUserVectorLayer.getSource().clear(),N.lockedTasksForCurrentUser.length>0){var t=u.getTaskFeaturesByIds(N.taskVectorLayer.getSource().getFeatures(),N.lockedTasksForCurrentUser);N.lockedByCurrentUserVectorLayer.getSource().addFeatures(t)}},function(){N.lockedByCurrentUserVectorLayer&&N.lockedByCurrentUserVectorLayer.getSource().clear(),N.lockedTasksForCurrentUser=[]})}function F(e){var t=new ol.source.Vector,r=new ol.layer.Vector({source:t,name:"aoi"});N.map.addLayer(r);var n=d.getFeatureFromGeoJSON(e);t.addFeature(n)}function O(e){var t=new ol.source.Vector,r=new ol.layer.Vector({source:t,name:"priorityareas"});if(N.map.addLayer(r),t.on("addfeature",function(e){var t=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,0,0,0.2)"}),stroke:new ol.style.Stroke({color:"rgba(255,0,0,1)",width:1})});e.feature.setStyle(t)}),e){for(var n=0;n<e.length;n++){var a=d.getFeatureFromGeoJSON(e[n]);t.addFeature(a)}e.length>0&&(N.hasPriorityArea=!0)}}function D(e){if(!e)return N.selectedTaskData=null,N.lockedTaskData=null,N.multiSelectedTasksData=[],N.multiLockedTasks=[],N.resetErrors(),N.resetStatusFlags(),N.clearCurrentSelection(),N.mappingStep="selecting",void(N.validatingStep="selecting");var t=e.get("taskId"),r=N.projectData.projectId;u.getTask(r,t).then(function(e){N.resetErrors(),N.resetStatusFlags(),N.selectedTaskData=null,N.lockedTaskData=null,N.multiSelectedTasksData=[],N.multiLockedTasks=[],b(e),"description"!==N.currentTab&&"instructions"!==N.currentTab||(N.currentTab=N.isSelectedValidatable?"validation":"mapping")},function(){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),N.taskErrorMapping="task-get-error",N.taskErrorValidation="task-get-error",N.mappingStep="selecting",N.validatingStep="selecting","description"!==N.currentTab&&"instructions"===N.currentTab||(N.currentTab="mapping")})}function b(e){var t="LOCKED_FOR_MAPPING"===e.taskStatus&&e.lockHolder===N.user.username,r="LOCKED_FOR_VALIDATION"===e.taskStatus&&e.lockHolder===N.user.username;N.isSelectedMappable=t||"READY"===e.taskStatus||"INVALIDATED"===e.taskStatus,N.isSelectedValidatable=r||"MAPPED"===e.taskStatus||"VALIDATED"===e.taskStatus||"BADIMAGERY"===e.taskStatus,N.selectedTaskData=e;var a=N.selectedTaskData.taskHistory;if(a)for(var o=0;o<a.length;o++)a[o].actionText=v.formatUserNamesToLink(a[o].actionText);t?(N.mappingStep="locked",N.lockedTaskData=e,N.currentTab="mapping"):N.mappingStep="viewing",r?(N.validatingStep="locked",N.lockedTaskData=e,N.currentTab="validation"):N.validatingStep="viewing",n.search("task",e.taskId)}function V(e,t){var r=u.getTaskFeatureById(e,t);r.getProperties();return r.getProperties().taskSplittable}function U(e,t){if(P(e),N.taskLockError=!0,401==t.status)N.isAuthorized=!1;else if(409==t.status){N.isAuthorized=!0,N.hasAcceptedLicenseTerms=!1;var r=h.getLicense(N.projectData.licenseId);r.then(function(e){N.license=e,N.showLicenseModal=!0},function(){})}else N.isAuthorized=!0,N.taskLockErrorMessage=t.data.Error}function G(e,t){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),N.clearCurrentSelection(),P(e),N.taskUnLockError=!0,401==t.status?N.isAuthorized=!1:(N.isAuthorized=!0,N.taskUnLockErrorMessage=t.data.Error)}var N=this;N.id=0,N.projectData=null,N.taskVectorLayer=null,N.highlightVectorLayer=null,N.lockedByCurrentUserVectorLayer=null,N.map=null,N.user=null,N.maxlengthComment=500,N.taskUrl="",N.currentTab="",N.mappingStep="",N.validatingStep="",N.userCanMap=!0,N.userCanValidate=!0,N.taskErrorMapping="",N.taskErrorValidation="",N.taskLockError=!1,N.taskLockErrorMessage="",N.taskUnLockError=!1,N.taskUnLockErrorMessage="",N.taskSplitError=!1,N.taskSplitCode,N.isAuthorized=!1,N.isSelectedMappable=!1,N.isSelectedValidatable=!1,N.isSelectedSplittable=!1,N.selectedTaskData=null,N.lockedTaskData=null,N.multiSelectedTasksData=[],N.multiLockedTasks=[],N.editorStartError="",N.selectedEditor="ideditor",N.selectInteraction=null,N.mappedTasksPerUser=[],N.lockedTasksForCurrentUser=[],N.comment="",N.usernames=[],N.propertyName="username",N.reverse=!0,N.showLicenseModal=!1,N.lockingReason="";var R=void 0;r.$watch(function(){return k.getLanguageCode()},function(){A(N.id)},!0),function(){N.currentTab="instructions",N.mappingStep="selecting",N.validatingStep="selecting",N.selectedEditor="ideditor",s.createOSMMap("map"),s.addOverviewMap(),N.map=s.getOSMMap(),N.id=a.id,C(N.id);var e=p.getSession();e&&e.username&&""!=e.username?f.getUser(e.username).then(function(e){N.user=e,I(N.id)},function(){I(N.id)}):I(N.id),"chat"===n.search().tab&&(N.currentTab="chat"),R=t(function(){P(N.id),C(N.id)},1e4),N.selectedEditor=y.getFavouriteEditor()}(),r.$on("$routeChangeStart",function(){angular.isDefined(R)&&(t.cancel(R),R=void 0)}),N.resetTaskData=function(){N.selectedTaskData=null,N.lockedTaskData=null,N.multiSelectedTasksData=[],N.multiLockedTasks=[],N.lockedTasksForCurrentUser=[]},N.updatePreferedEditor=function(){y.setFavouriteEditor(N.selectedEditor)},N.resetStatusFlags=function(){N.isSelectedMappable=!1,N.isSelectedValidatable=!1,N.isSelectedSplittable=!1},N.resetErrors=function(){N.taskErrorMapping="",N.taskErrorValidation="",N.taskLockError=!1,N.taskLockErrorMessage="",N.taskUnLockError=!1,N.taskUnLockErrorMessage="",N.taskSplitError=!1,N.taskSplitCode,N.taskUndoError=!1},N.selectRandomTaskMap=function(){var e=u.getRandomMappableTaskFeature(N.taskVectorLayer.getSource().getFeatures());if(e){T(e);var t=j();N.map.getView().fit(e.getGeometry().getExtent(),{padding:[t,t,t,t]})}else N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),N.taskErrorMapping="none-available",N.mappingStep="selecting",N.validatingStep="selecting"},N.selectRandomTaskValidate=function(){var e=u.getRandomTaskFeatureForValidation(N.taskVectorLayer.getSource().getFeatures());if(e){T(e);var t=j();N.map.getView().fit(e.getGeometry().getExtent(),{padding:[t,t,t,t]})}else N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),N.taskErrorValidation="none-available",N.mappingStep="selecting",N.validatingStep="selecting"},N.selectByPolygonValidate=function(){N.drawPolygonInteraction.getActive()?(S.getSource().clear(),N.selectInteraction.setActive(!0),N.drawPolygonInteraction.setActive(!1)):(N.selectInteraction.setActive(!1),N.drawPolygonInteraction.setActive(!0))},N.clearCurrentSelection=function(){N.selectInteraction.getFeatures().clear()},N.undo=function(){N.taskUndoError=!1;var e=N.projectData.projectId,t=N.selectedTaskData.taskId;u.undo(e,t).then(function(e){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),b(e),P(N.projectData.projectId)},function(e){N.taskUndoError=!0})},N.hasTaskLockedForMapping=function(){if(N.taskVectorLayer){return 1==u.getTaskFeaturesByIdAndStatus(N.taskVectorLayer.getSource().getFeatures(),N.lockedTasksForCurrentUser,"LOCKED_FOR_MAPPING").length}},N.reselectTaskForMapping=function(){if(N.taskVectorLayer){var e=u.getTaskFeaturesByIdAndStatus(N.taskVectorLayer.getSource().getFeatures(),N.lockedTasksForCurrentUser,"LOCKED_FOR_MAPPING");if(1==e.length){T(e[0]),D(e[0]);var t=j();N.map.getView().fit(e[0].getGeometry().getExtent(),{padding:[t,t,t,t]})}}},N.hasTasksLockedForValidation=function(){if(N.taskVectorLayer){return u.getTaskFeaturesByIdAndStatus(N.taskVectorLayer.getSource().getFeatures(),N.lockedTasksForCurrentUser,"LOCKED_FOR_VALIDATION").length>0}},N.reselectTasksForValidation=function(){if(N.taskVectorLayer){var e=u.getTaskFeaturesByIdAndStatus(N.taskVectorLayer.getSource().getFeatures(),N.lockedTasksForCurrentUser,"LOCKED_FOR_VALIDATION");if(1==e.length){T(e[0]),D(e[0]);var t=j();N.map.getView().fit(e[0].getGeometry().getExtent(),{padding:[t,t,t,t]})}else if(e.length>1){N.selectInteraction.getFeatures().clear(),e.forEach(function(e){N.selectInteraction.getFeatures().push(e)});var r=d.getBoundingExtentFromFeatures(e);N.map.getView().fit(r);var n=u.getLockedTaskDetailsForCurrentUser(N.projectData.projectId);n.then(function(e){var t=e.filter(function(e){if("LOCKED_FOR_VALIDATION"==e.taskStatus)return e});N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),N.currentTab="validation",N.validatingStep="multi-locked",N.multiSelectedTasksData=t,N.multiLockedTasks=t,N.isSelectedValidatable=!0},function(e){})}}},N.getSocialMediaUrl=function(){return n.absUrl()},N.unLockTaskMapping=function(e,t){var r=N.projectData.projectId,n=N.lockedTaskData.taskId,a=u.unLockTaskMapping(r,n,e,t);N.comment="",a.then(function(e){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),P(r),C(r),N.clearCurrentSelection(),N.mappingStep="selecting",N.validatingStep="selecting"},function(e){G(r,e)})},N.stopMapping=function(e){var t=N.projectData.projectId,r=N.lockedTaskData.taskId,n=u.stopMapping(t,r,e);N.comment="",n.then(function(e){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),P(t),C(t),N.clearCurrentSelection(),N.mappingStep="selecting",N.validatingStep="selecting"},function(e){G(t,e)})},N.unLockTaskValidation=function(e,t){var r=N.projectData.projectId,n=N.lockedTaskData.taskId,a=[{comment:e,status:t,taskId:n}],o=u.unLockTaskValidation(r,a);N.comment="",o.then(function(e){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),P(r),C(r),N.clearCurrentSelection(),N.mappingStep="selecting",N.validatingStep="selecting"},function(e){G(r,e)})},N.stopValidating=function(e){var t=N.projectData.projectId,r=N.lockedTaskData.taskId,n=[{comment:e,taskId:r}],a=u.stopValidating(t,n);N.comment="",a.then(function(e){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),P(t),C(t),N.clearCurrentSelection(),N.mappingStep="selecting",N.validatingStep="selecting"},function(e){G(t,e)})},N.unLockMultiTaskValidation=function(e,t){var r=N.projectData.projectId,n=N.multiLockedTasks,a=n.map(function(r){return{comment:e,status:t,taskId:r.taskId}});N.resetErrors(),N.resetStatusFlags(),N.resetTaskData();var o=u.unLockTaskValidation(r,a);N.comment="",o.then(function(e){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),P(r),C(r),N.clearCurrentSelection(),N.mappingStep="selecting",N.validatingStep="selecting"},function(e){G(r,e)})},N.stopMultiTaskValidation=function(e){var t=N.projectData.projectId,r=N.multiLockedTasks,n=r.map(function(t){return{comment:e,taskId:t.taskId}});N.resetErrors(),N.resetStatusFlags(),N.resetTaskData();var a=u.stopValidating(t,n);N.comment="",a.then(function(e){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),P(t),C(t),N.clearCurrentSelection(),N.mappingStep="selecting",N.validatingStep="selecting"},function(e){G(t,e)})},N.lockSelectedTaskMapping=function(){N.lockingReason="MAPPING";var e=N.projectData.projectId,t=N.selectedTaskData.taskId;u.lockTaskMapping(e,t).then(function(t){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),P(e),C(e),N.currentTab="mapping",N.mappingStep="locked",N.selectedTaskData=t,N.isSelectedMappable=!0,N.lockedTaskData=t,N.isSelectedSplittable=V(N.taskVectorLayer.getSource().getFeatures(),t.taskId)},function(t){U(e,t)})},N.splitTask=function(){N.taskSplitError=!1,N.taskSplitCode;var e=N.projectData.projectId,t=N.selectedTaskData.taskId;u.splitTask(e,t).then(function(t){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),P(e),C(e),N.clearCurrentSelection(),N.mappingStep="selecting",N.validatingStep="selecting",n.search("task",null)},function(e){N.taskSplitError=!0,N.taskSplitCode=null,(e.status=403)&&(N.taskSplitCode=403)})},N.lockSelectedTaskValidation=function(){N.lockingReason="VALIDATION";var e=N.projectData.projectId,t=N.selectedTaskData.taskId,r=[t];u.lockTasksValidation(e,r).then(function(t){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),P(e),C(e),N.currentTab="validation",N.validatingStep="locked",N.selectedTaskData=t[0],N.isSelectedValidatable=!0,N.lockedTaskData=t[0]},function(t){U(e,t)})},N.viewOSMChangesets=function(){var e=N.selectedTaskData.taskId,t=N.taskVectorLayer.getSource().getFeatures(),r=u.getTaskFeatureById(t,e),n=r.getGeometry().getExtent(),a=d.transformExtentToLatLonString(n);o.open("http://www.openstreetmap.org/history?bbox="+a)},N.viewOverpassTurbo=function(){
var e="",t=N.selectedTaskData.taskId,r=N.taskVectorLayer.getSource().getFeatures(),n=u.getTaskFeatureById(r,t),a=n.getGeometry().getExtent(),i=d.transformExtentToLatLonArray(a),s='w="'+i[0]+'" s="'+i[1]+'" e="'+i[2]+'" n="'+i[3]+'"',c=[],l=N.selectedTaskData.taskHistory;if(l)for(var g=0;g<l.length;g++){var p=l[g].actionBy,f=c.indexOf(p);if(p&&-1==f){var m='<query type="node"><user name="'+p+'"/><bbox-query '+s+'/></query><query type="way"><user name="'+p+'"/><bbox-query '+s+'/></query><query type="relation"><user name="'+p+'"/><bbox-query '+s+"/></query>";e+=m,c.push(p)}}var h='<osm-script output="json" timeout="25"><union>'+e+'</union><print mode="body"/><recurse type="down"/><print mode="skeleton" order="quadtile"/></osm-script>';o.open("http://overpass-turbo.eu/map.html?Q="+encodeURIComponent(h))},N.startEditor=function(e){N.editorStartError="";var t=N.selectInteraction.getFeatures(),r=t.getArray().length,n=d.getBoundingExtentFromFeatures(t.getArray());N.map.getView().fit(n);var a=d.transformExtentToLatLonArray(n),o=N.projectData.imagery,i=N.projectData.changesetComment,s=ol.proj.transform(d.getCenterOfExtent(n),"EPSG:3857","EPSG:4326");if("ideditor"===e)g.launchIdEditor(s,i,o,N.projectData.projectId,N.getSelectTaskIds());else if("potlatch2"===e)g.launchPotlatch2Editor(s);else if("fieldpapers"===e)g.launchFieldPapersEditor(s);else if("josm"===e){if(r>1){var c={new_layer:!0,mime_type:encodeURIComponent("application/x-osm+xml"),layer_name:encodeURIComponent("Task Boundaries #"+N.projectData.projectId+"- Do not edit or upload"),data:encodeURIComponent('<?xml version="1.0" encoding="utf8"?><osm generator="JOSM" upload="never" version="0.6"></osm>')},l=g.sendJOSMCmd("http://127.0.0.1:8111/load_data",c);l||(N.editorStartError="josm-error");var u={url:g.getOSMXMLUrl(N.projectData.projectId,N.getSelectTaskIds()),new_layer:!1},p=g.sendJOSMCmd("http://127.0.0.1:8111/import",u);p||(N.editorStartError="josm-error")}var f="Bing",m=!1;if(o&&void 0!==o&&""!==o&&(f=o,m=!0),m){var h={title:encodeURIComponent("Tasking Manager Imagery - #"+N.projectData.projectId),type:o.toLowerCase().substring(0,3),url:encodeURIComponent(o)},v=g.sendJOSMCmd("http://127.0.0.1:8111/imagery",h);v||(N.editorStartError="josm-imagery-error")}var S={new_layer:!0,mime_type:"application/x-osm+xml",layer_name:"OSM Data",data:encodeURIComponent('<?xml version="1.0" encoding="utf8"?><osm generator="JOSM" version="0.6"></osm>')},k=g.sendJOSMCmd("http://127.0.0.1:8111/load_data",S);k||(N.editorStartError="josm-error");var y={left:a[0],bottom:a[1],right:a[2],top:a[3],changeset_comment:encodeURIComponent(i),changeset_source:encodeURIComponent(f),new_layer:!1};1==r?g.sendJOSMCmd("http://127.0.0.1:8111/load_and_zoom",y):g.sendJOSMCmd("http://127.0.0.1:8111/zoom",y)}},N.setShowLicenseModal=function(e){N.showLicenseModal=e},N.acceptLicense=function(){m.acceptLicense(N.projectData.licenseId).then(function(){N.showLicenseModal=!1,"MAPPING"===N.lockingReason?N.lockSelectedTaskMapping():"VALIDATION"===N.lockingReason&&N.lockSelectedTaskValidation()},function(){})},N.getSelectTaskIds=function(){if(N.multiLockedTasks&&N.multiLockedTasks.length>0){return N.multiLockedTasks.map(function(e){return e.taskId}).join(",")}return N.lockedTaskData?N.lockedTaskData.taskId:null},N.highlightTasks=function(e){var t=u.getTaskFeaturesByIds(N.taskVectorLayer.getSource().getFeatures(),e);N.highlightVectorLayer.getSource().addFeatures(t)},N.lockTasksForValidation=function(e){N.selectInteraction.getFeatures().clear(),N.projectData.tasks.features.filter(function(t){var r=e.indexOf(t.properties.taskId);if(-1!==r)return e[r]}).forEach(function(e){var e=u.getTaskFeatureById(N.taskVectorLayer.getSource().getFeatures(),e.properties.taskId);N.selectInteraction.getFeatures().push(e)}),u.lockTasksValidation(N.projectData.projectId,e).then(function(e){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),P(N.projectData.projectId),N.currentTab="validation",N.validatingStep="multi-locked",N.multiSelectedTasksData=e,N.multiLockedTasks=e,N.isSelectedValidatable=!0},function(e){U(N.projectData.projectId,e)})},N.resetToSelectingStep=function(){N.resetErrors(),N.resetStatusFlags(),N.resetTaskData(),N.clearCurrentSelection(),N.mappingStep="selecting",N.validatingStep="selecting"},N.getGpxDownloadURL=function(){return N.projectData&&N.getSelectTaskIds()?i.tmAPI+"/project/"+N.projectData.projectId+"/tasks_as_gpx?tasks="+N.getSelectTaskIds()+"&as_file=true":""},N.sortBy=function(e){N.reverse=N.propertyName===e&&!N.reverse,N.propertyName=e},N.searchUser=function(e){return m.searchUser(e).then(function(e){if(N.usernames=[],e.usernames)for(var t=0;t<e.usernames.length;t++)N.usernames.push({label:e.usernames[t]});return e.usernames},function(){})},N.formatUserTag=function(e){return"@["+e.label+"]"}}angular.module("taskingManager").controller("projectController",["$timeout","$interval","$scope","$location","$routeParams","$window","configService","mapService","projectService","styleService","taskService","geospatialService","editorService","authService","accountService","userService","licenseService","messageService","drawService","languageService","userPreferencesService",e])}(),function(){function e(e,t,r,n){function a(e){if(e){i(e).then(function(e){s=e})}else s={username:"",role:"",mappingLevel:""}}function o(){return s}function i(a){return e({method:"GET",url:r.tmAPI+"/user/"+a,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}var s={username:"",role:"",mappingLevel:""};return{setAccount:a,getAccount:o,getUser:i}}angular.module("taskingManager").service("accountService",["$http","$q","configService","authService",e])}(),function(){function e(e,t,r,n){function a(n){o();var a="";a=n||t.path(),e.location.href=r.tmAPI+"/auth/login?redirect_to="+a}function o(){localStorage.removeItem(p),i("","")}function i(e,t){g=e,d={sessionToken:e,username:t},localStorage.setItem(p,JSON.stringify(d))}function s(){return d}function c(){var e=n.getLanguageCode();return{"Content-Type":"application/json; charset=UTF-8",Authorization:"Token "+btoa(g),"Accept-Language":e}}function l(){return p}function u(){return!!d.username}var d={},g="",p="session";return{login:a,logout:o,setSession:i,getSession:s,getAuthenticatedHeader:c,getLocalStorageSessionName:l,isUserLoggedIn:u}}angular.module("taskingManager").service("authService",["$window","$location","configService","languageService",e])}(),function(){function e(e){function t(t,a,i,c,u,g){S=e.getOSMMap(),k=new ol.Collection,r(),t&&n(),a&&o(),i&&s(),c&&d(),u&&p(),g&&l()}function r(){h=new ol.source.Vector({features:k}),v=new ol.layer.Vector({source:h}),v.setZIndex(100),S.addLayer(v)}function n(){y=new ol.interaction.Draw({type:"Polygon",source:h}),y.setActive(!1),S.addInteraction(y)}function a(){return y}function o(){j=new ol.interaction.Draw({type:"Circle",source:h,geometryFunction:ol.interaction.Draw.createBox()}),j.setActive(!1),S.addInteraction(j)}function i(){return j}function s(){T=new ol.interaction.Draw({type:"Circle",source:h,geometryFunction:ol.interaction.Draw.createRegularPolygon()}),T.setActive(!1),S.addInteraction(T)}function c(){return T}function l(){var e=k;w&&(e=w.getFeatures()),I=new ol.interaction.Modify({features:e,deleteCondition:function(e){return ol.events.condition.shiftKeyOnly(e)&&ol.events.condition.singleClick(e)}}),S.addInteraction(I)}function u(){return I}function d(){w=new ol.interaction.Select({layers:[v]}),S.addInteraction(w)}function g(){return w}function p(){A=new ol.interaction.Translate({features:w.getFeatures()}),S.addInteraction(A)}function f(){return A}function m(){return h}var h=null,v=null,S=null,k=null,y=null,j=null,T=null,w=null,I=null,A=null;return{initInteractions:t,getDrawPolygonInteraction:a,getDrawRectangleInteraction:i,getDrawCircleInteraction:c,getModifyInteraction:u,getSelectInteraction:g,getTranslateInteraction:f,getSource:m}}angular.module("taskingManager").service("drawService",["mapService",e])}(),function(){function e(e,t,r,n){function a(t){var n=r.getOSMMap().getView().getZoom(),a="http://fieldpapers.org/compose#"+[n,t[1],t[0]].join("/");e.open(a)}function o(t){var n=r.getOSMMap().getView().getZoom(),a="http://www.openstreetmap.org/edit?editor=potlatch2#map="+[n,s(t[1],5),s(t[0],5)].join("/");e.open(a)}function i(t,n,a,o,i){var s=r.getOSMMap().getView().getZoom(),c="http://www.openstreetmap.org/edit?editor=id&#map="+[s,t[1],t[0]].join("/"),l="";if(n&&""!==n&&(l=n),c+="&comment="+encodeURIComponent(l),a&&""!==a){var d=a.substring(a.indexOf("http"));d=d.replace("zoom","z"),c+="&background=custom:"+encodeURIComponent(d)}o&&""!==o&&i&&""!==i&&(c+="&gpx="+u(o,i)),e.open(c)}function s(e,t){var r=Math.pow(10,t);return Math.round(e*r)/r}function c(e){return"?"+Object.keys(e).map(function(t){return t+"="+e[t]}).join("&")}function l(e,t){var r=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),n=e+c(t),a=!1;r.onreadystatechange=function(){4==this.readyState&&(a=200==this.status)};try{r.open("GET",n,!1),r.send()}catch(e){a=!1}return a}function u(e,r,a){var o=n.tmAPI+"/project/"+e+"/tasks_as_gpx?tasks="+r+"&as_file="+!!a;return-1==o.indexOf("http")&&(o=t.protocol()+"://"+t.host()+o),encodeURIComponent(o)}function d(e,r){var a=n.tmAPI+"/project/"+e+"/tasks-as-osm-xml?tasks="+r;return-1==a.indexOf("http")&&(a=t.protocol()+"://"+t.host()+a),encodeURIComponent(a)}return{sendJOSMCmd:l,launchFieldPapersEditor:a,launchPotlatch2Editor:o,launchIdEditor:i,getGPXUrl:u,getOSMXMLUrl:d}}angular.module("taskingManager").service("editorService",["$window","$location","mapService","configService",e])}(),function(){function e(){function e(e,t){return(new ol.format.GeoJSON).readFeatures(e,{dataProjection:t||d,featureProjection:g})}function t(e){return(new ol.format.GeoJSON).readFeature(e,{dataProjection:d,featureProjection:g})}function r(e){return new ol.format.KML({extractStyles:!1,showPointNames:!1}).readFeatures(e,{dataProjection:d,featureProjection:g})}function n(e){return(new ol.format.GeoJSON).writeFeature(e,{dataProjection:d,featureProjection:g})}function a(e){return(new ol.format.GeoJSON).writeFeatureObject(e,{dataProjection:d,featureProjection:g})}function o(e){return(new ol.format.GeoJSON).writeFeatures(e,{dataProjection:d,featureProjection:g})}function i(e,t){return(new ol.format.GeoJSON).writeFeaturesObject(e,{dataProjection:t||d,featureProjection:g})}function s(e){return[e[0]+(e[2]-e[0])/2,e[1]+(e[3]-e[1])/2]}function c(e){var t=ol.proj.transform([e[0],e[1]],g,d),r=ol.proj.transform([e[2],e[3]],g,d);return t[0]+","+t[1]+","+r[0]+","+r[1]}function l(e){var t=ol.proj.transform([e[0],e[1]],g,d),r=ol.proj.transform([e[2],e[3]],g,d);return[t[0],t[1],r[0],r[1]]}function u(e){if(!Array.isArray(e))return null;if(e.length<1)return null;for(var t=0;t<e.length;t++)if(!(e[t]instanceof ol.Feature))return null;for(var r=e[0].getGeometry().getExtent(),t=1;t<e.length;t++)r=ol.extent.extend(r,e[t].getGeometry().getExtent());return r}var d="EPSG:4326",g="EPSG:3857";return{getFeaturesFromGeoJSON:e,getFeatureFromGeoJSON:t,getFeaturesFromKML:r,getGeoJSONFromFeature:n,getGeoJSONObjectFromFeature:a,getGeoJSONFromFeatures:o,getGeoJSONObjectFromFeatures:i,getCenterOfExtent:s,transformExtentToLatLonString:c,transformExtentToLatLonArray:l,getBoundingExtentFromFeatures:u}}angular.module("taskingManager").service("geospatialService",[e])}(),function(){function e(e,t){return{response:function(e){return e},responseError:function(r){if(401===r.status){var n=t.path();t.path("/login/").search({redirect_to:n})}return e.reject(r)}}}angular.module("taskingManager").factory("httpInterceptorService",["$q","$location",e])}(),function(){function e(){function e(e){r=e}function t(){return r}var r="en";return{setLanguageCode:e,getLanguageCode:t}}angular.module("taskingManager").service("languageService",[e])}(),function(){function e(e,t,r,n){function a(a){return e({method:"GET",url:r.tmAPI+"/license/"+a,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function o(a){return e({method:"PUT",url:r.tmAPI+"/license",data:a,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function i(a){return e({method:"DELETE",url:r.tmAPI+"/license/"+a,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function s(a,o){return e({method:"POST",url:r.tmAPI+"/license/"+o,data:a,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function c(){return e({method:"GET",url:r.tmAPI+"/license/list",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}return{getLicense:a,createLicense:o,deleteLicense:i,updateLicense:s,getLicenseList:c}}angular.module("taskingManager").service("licenseService",["$http","$q","configService","authService",e])}(),function(){function e(e){function t(t,r){var a=new ol.control.ScaleLine,c=new ol.control.Attribution({collapsible:!1});l=new ol.Map({layers:[new ol.layer.Tile({source:new ol.source.OSM({url:"//{a-c}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",attributions:"<a href='http://www.openstreetmap.org/copyright/' target='_blank'>© OpenStreetMap</a> contributors"}),title:"OpenStreetMap",type:"base"})],controls:ol.control.defaults({attribution:!1}).extend([c]),target:t,view:new ol.View({center:[0,0],zoom:2})}),r&&l.getInteractions().forEach(function(e){e instanceof ol.interaction.MouseWheelZoom&&e.setActive(!1)},this),l.addControl(a);var u=e.layers;if(u)for(var d=0;d<u.length;d++)"XYZ"===u[d].type&&o(u[d].name,u[d].url,u[d].attribution),"WMS"===u[d].type&&i(u[d].name,u[d].url,u[d].layerName,u[d].attribution),"bing"===u[d].type&&s(u[d].name,u[d].key,u[d].imagerySet,u[d].attribution);n()}function r(){return l}function n(){var e=new ol.control.LayerSwitcher;l.addControl(e)}function a(){var e=l.getView().getMaxResolution(),t=new ol.control.OverviewMap({className:"ol-overviewmap ol-custom-overviewmap",view:new ol.View({resolutions:[e]})});l.addControl(t)}function o(e,t,r,n){var a=!1;n&&(a=!0);var o=new ol.source.XYZ({url:t});r&&o.setAttributions(r);var i=new ol.layer.Tile({visible:a,preload:1/0,title:e,type:"base",source:o});l.addLayer(i)}function i(e,t,r,n,a){var o=!1;a&&(o=!0);var i=new ol.source.TileWMS({url:t,params:{LAYERS:r}});n&&i.setAttributions(n);var s=new ol.layer.Tile({visible:o,title:e,type:"base",source:i});l.addLayer(s)}function s(e,t,r,n,a){var o=!1;a&&(o=!0);var i=new ol.source.BingMaps({key:t,imagerySet:r});n&&i.setAttributions(n);var s=new ol.layer.Tile({preload:1/0,visible:o,title:e,type:"base",source:i});l.addLayer(s)}function c(){var e=new Geocoder("nominatim",{provider:"osm",lang:"en",placeholder:"Search for ...",targetType:"glass-button",limit:5,keepOpen:!0,preventDefault:!0});l.addControl(e),e.on("addresschosen",function(e){l.getView().setCenter(e.coordinate),l.getView().setZoom(12)})}var l=null;return{createOSMMap:t,getOSMMap:r,addXYZLayer:o,addTiledWMSLayer:i,addBingLayer:s,addGeocoder:c,addOverviewMap:a}}angular.module("taskingManager").service("mapService",["configService",e])}(),function(){function e(e,t,r,n){function a(a,o,i){return e({method:"POST",url:r.tmAPI+"/admin/project/"+a+"/message-all",data:{message:i,subject:o},headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function o(){return e({method:"GET",url:r.tmAPI+"/messages/has-new-messages",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function i(){return e({method:"GET",url:r.tmAPI+"/messages/get-all-messages",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(e){return t.reject(e)})}function s(a){return e({method:"GET",url:r.tmAPI+"/messages/"+a,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function c(a){return e({method:"DELETE",url:r.tmAPI+"/messages/"+a,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function l(){return e({method:"POST",url:r.tmAPI+"/messages/resend-email-verification",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function u(n){return e({method:"GET",url:r.tmAPI+"/project/"+n+"/chat"}).then(function(e){return e.data},function(e){return t.reject(e)})}function d(a,o){return e({method:"PUT",url:r.tmAPI+"/project/"+o+"/chat",data:{message:a},headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(e){return t.reject(e)})}function g(e){var t=/@\[([^\]]+)\]/gi,r=e&&e.match(t);if(r)for(var n=0;n<r.length;n++){var a=r[n].substring(2,r[n].length);a=a.substring(0,a.length-1),e=e.replace(r[n],'<a href="/user/'+a+'">'+a+"</a>")}return e}return{messageAll:a,hasNewMessages:o,getAllMessages:i,getMessage:s,getProjectChatMessages:u,addProjectChatMessage:d,deleteMessage:c,resendEmailVerification:l,formatUserNamesToLink:g}}angular.module("taskingManager").service("messageService",["$http","$q","configService","authService",e])}(),function(){function e(e,t,r,n,a,o){function i(e){G=e,s()}function s(){x=new ol.source.Vector;var e=new ol.layer.Vector({source:x});e.setZIndex(100),G.addLayer(e)}function c(e,t){for(var r=Math.ceil(e[0]),n=Math.ceil(e[1]),a=Math.floor(e[2]),o=Math.floor(e[3]),i=U/Math.pow(2,t-1),s=parseInt(Math.floor((r+U)/i)),c=parseInt(Math.ceil((a+U)/i)),l=parseInt(Math.floor((n+U)/i)),u=parseInt(Math.ceil((o+U)/i)),d=[],g=s;g<c;g++)for(var p=l;p<u;p++){var f=m(i,g,p);f.setProperties({x:g,y:p,zoom:t,splittable:!0}),d.push(f)}return d}function l(){return N}function u(e){N=e}function d(){x.clear(),N=null}function g(){var e=a.getGeoJSONFromFeature(N[0]);return turf.area(JSON.parse(e))/1e6}function p(){var e=0;return N&&(e=N.length),e}function f(){x.addFeatures(N)}function m(e,t,r){var n=t*e-U,a=r*e-U,o=(t+1)*e-U,i=(r+1)*e-U,s=new ol.geom.Polygon.fromExtent([n,a,o,i]),c=new ol.geom.MultiPolygon;return c.appendPolygon(s),new ol.Feature({geometry:c})}function h(e){R=e}function v(){return R}function S(e){var t={valid:!0,message:""};if(!e||!e.length||0==e.length)return t.valid=!1,t.message="NO_FEATURES",t;for(var r=0;r<e.length;r++)if(!(e[r]instanceof ol.Feature))return t.valid=!1,t.message="UNKNOWN_OBJECT_CLASS",t;if(!e.every(function(e){var t=e.getGeometry().getType();return"MultiPolygon"===t||"Polygon"===t}))return t.valid=!1,t.message="CONTAINS_NON_POLYGON_FEATURES",t;for(var n=0;n<e.length;n++){var a=[];"MultiPolygon"===e[n].getGeometry().getType()?e[n].getGeometry().getPolygons().forEach(function(e){var t=new ol.Feature({geometry:e});this.push(t)},a):a.push(e[n]);if(a.every(function(e){return j(e)}))return t.valid=!1,t.message="SELF_INTERSECTIONS",t}return t}function k(e){for(var t=a.getGeoJSONObjectFromFeature(e),r=[],n=0;n<N.length;n++){var o=a.getGeoJSONObjectFromFeature(N[n]);if(turf.intersect(t,o))for(var i=y(N[n]),s=0;s<i.length;s++)r.push(i[s]);else r.push(N[n])}d(),u(r),f()}function y(e){var t=e.getProperties().zoom+1;return c(e.getGeometry().getExtent(),t)}function j(e){var t=!1,r=a.getGeoJSONObjectFromFeature(e);return turf.kinks(r).features.length>0&&(t=!0),t}function T(o,i,s){var c=a.getGeoJSONObjectFromFeatures(R),l=i?a.getGeoJSONObjectFromFeatures(N):null,u={areaOfInterest:c,projectName:o,tasks:l,arbitraryTasks:!i};return s&&(u.cloneFromProjectId=s),e({method:"PUT",url:r.tmAPI+"/admin/project",data:u,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(e){return t.reject(e)})}function w(n){var a=o.getLanguageCode();return e({method:"GET",url:r.tmAPI+"/project/"+n,headers:{"Content-Type":"application/json; charset=UTF-8","Accept-Language":a}}).then(function(e){return e.data},function(){return t.reject("error")})}function I(a){return e({method:"GET",url:r.tmAPI+"/admin/project/"+a,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function A(a,o){return e({method:"POST",url:r.tmAPI+"/admin/project/"+a,data:o,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function P(a){return e({method:"DELETE",url:r.tmAPI+"/admin/project/"+a,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function L(a){return e({method:"POST",url:r.tmAPI+"/admin/project/"+a+"/invalidate-all",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function M(a){return e({method:"POST",url:r.tmAPI+"/admin/project/"+a+"/validate-all",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function C(a){return e({method:"GET",url:r.tmAPI+"/admin/project/"+a+"/comments",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function E(e){var t=-1;switch(e){case"BEGINNER":t=1;break;case"INTERMEDIATE":t=2;break;case"ADVANCED":t=3}return t}function F(e,t,r){if(r){var e=E(e),t=E(t);return e>=t}return!0}function O(e,t){if(t){return-1!=["ADMIN","PROJECT_MANAGER","VALIDATOR"].indexOf(e)}return!0}function D(){return e({method:"GET",url:r.tmAPI+"/admin/my-projects",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function b(o){var i=a.getGeoJSONObjectFromFeatures(R,"EPSG:3857"),s=a.getGeoJSONObjectFromFeatures(N,"EPSG:3857"),c={areaOfInterest:i,clipToAoi:o,grid:s};return e({method:"PUT",url:r.tmAPI+"/grid/intersecting-tiles",data:c,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(e){return t.reject(e)})}function V(n){var a=o.getLanguageCode();return e({method:"GET",url:r.tmAPI+"/project/"+n+"/summary",headers:{"Content-Type":"application/json; charset=UTF-8","Accept-Language":a}}).then(function(e){return e.data},function(){return t.reject("error")})}var U=20037508.3392,G=null,N=null,R=null,x=null;return{initDraw:i,createTaskGrid:c,getTaskGrid:l,validateAOI:S,setTaskGrid:u,removeTaskGrid:d,getTaskSize:g,getNumberOfTasks:p,addTaskGridToMap:f,createProject:T,setAOI:h,getAOI:v,splitTasks:k,getProject:w,getProjectMetadata:I,updateProject:A,deleteProject:P,invalidateAllTasks:L,validateAllTasks:M,getCommentsForProject:C,userCanMapProject:F,userCanValidateProject:O,getMyProjects:D,trimTaskGrid:b,getProjectSummary:V}}angular.module("taskingManager").service("projectService",["$http","$q","configService","authService","geospatialService","languageService",e])}(),function(){function e(e,t,r,n,a){function o(e,t){A=t||null,S=e,i(),s()}function i(){if(k=new ol.source.Vector,A){var e=new ol.source.Cluster({distance:30,source:k}),t=new ol.layer.Vector({source:e,style:function(e,t){var r=e.get("features").length,n=I[r];return n||(n=[new ol.style.Style({image:new ol.style.Circle({radius:3*Math.min(5,r/20)+12,stroke:new ol.style.Stroke({color:"#fff"}),fill:new ol.style.Fill({color:"#3399CC"})}),text:new ol.style.Text({text:r.toString(),fill:new ol.style.Fill({color:"#fff"})})})],I[r]=n),n}});A&&t.setMinResolution(A),S.addLayer(t)}var n=new ol.layer.Vector({source:k,style:function(e){var t=e.getProperties().priority,n=I[t];return n||(n="URGENT"===t?r.getStyleWithColour("red"):"HIGH"===t?r.getStyleWithColour("orange"):"MEDIUM"===t?r.getStyleWithColour("yellow"):"LOW"===t?r.getStyleWithColour("blue"):r.getStyleWithColour("red"),I[t]=n),n}});A&&n.setMaxResolution(A),S.addLayer(n)}function s(){var e=r.getHighlightedProjectStyle();y=new ol.source.Vector;var t=new ol.layer.Vector({source:y,style:e});S.addLayer(t)}function c(e,t,r){var n="";t&&(n=t),r||k.clear();for(var a=0;a<e.length;a++)l(e[a],e[a].aoiCentroid,n)}function l(e,t,n,a){var o=ol.proj.transform(t.coordinates,"EPSG:4326","EPSG:3857"),i=new ol.Feature({geometry:new ol.geom.Point(o)});i.setProperties({projectId:e.projectId}),k&&(k.addFeature(i),i.setStyle(r.getStyleWithColour(n))),a&&S.getView().fit(i.getGeometry().getExtent(),{maxZoom:8})}function u(){k.clear()}function d(e,t){y.clear();for(var r=0;r<e.length;r++)if(e[r].id==t){var n=ol.proj.transform(e[r].aoiCentroid.coordinates,"EPSG:4326","EPSG:3857"),a=new ol.Feature({geometry:new ol.geom.Point(n)});y.addFeature(a)}}function g(){y.clear()}function p(e,t){w=null,j=angular.element('<div map-popup id="popup" class="ol-popup"></div>'),j.attr("selected-feature","feature"),w=new ol.Overlay({element:j[0],autoPan:!0,autoPanAnimation:{duration:250}}),e&&S.on("pointermove",function(e){if(!e.dragging){h(S.getEventPixel(e.originalEvent),e.coordinate)}}),t&&S.on("click",function(e){h(e.pixel,e.coordinate)}),S.addOverlay(w),w.setPosition(void 0)}function f(){S.removeOverlay(w)}function m(){w.setPosition(void 0)}function h(t,r){var n=S.forEachFeatureAtPixel(t,function(e){return e});if(n&&n.getProperties().projectId){e.getProjectSummary(n.getProperties().projectId).then(function(e){T.feature=e,w.setElement(j[0]),w.setPosition(r),a(j)(T)},function(){})}}function v(e){k.clear();var r=t.getFeaturesFromGeoJSON(e);k.addFeatures(r)}var S=null,k=null,y=null,j="",T=n.$new(!0),w=null,I={},A=null;return{initialise:o,showProjectsOnMap:c,showProjectOnMap:l,removeProjectsOnMap:u,highlightProjectOnMap:d,removeHighlightOnMap:g,addPopupOverlay:p,closePopup:m,removePopupOverlay:f,replaceFeatures:v}}angular.module("taskingManager").service("projectMapService",["projectService","geospatialService","styleService","$rootScope","$compile",e])}(),function(){function e(e,t,r,n,a){function o(o){n.getLanguageCode();return e({method:"GET",url:r.tmAPI+"/project/search",params:o,headers:a.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function i(n){return n.srid="4326",e({method:"GET",url:r.tmAPI+"/projects/within-bounding-box",params:n,headers:a.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}return{searchProjects:o,getProjectsWithinBBOX:i}}angular.module("taskingManager").service("searchService",["$http","$q","configService","languageService","authService",e])}(),function(){function e(e,t,r){function n(){return e({method:"GET",url:r.tmAPI+"/settings",headers:{"Content-Type":"application/json; charset=UTF-8"}}).then(function(e){return e.data},function(){return t.reject("error")})}return{getSettings:n}}angular.module("taskingManager").service("settingsService",["$http","$q","configService",e])}(),function(){function e(e,t,r){function n(n){return e({method:"GET",url:r.tmAPI+"/stats/project/"+n+"/contributions"}).then(function(e){return e.data},function(){return t.reject("error")})}function a(n,a){var o="";return a&&(o="?page="+a),e({method:"GET",url:r.tmAPI+"/stats/project/"+n+"/activity"+o}).then(function(e){return e.data},function(){return t.reject("error")})}function o(n){return e({method:"GET",url:r.tmAPI+"/stats/project/"+n}).then(function(e){return e.data},function(){return t.reject("error")})}function i(){return console.log("In service"),e({method:"GET",url:r.tmAPI+"/stats/home-page"}).then(function(e){return e.data},function(){return t.reject("error")})}return{getProjectContributions:n,getProjectActivity:a,getProjectStats:o,getHomePageStats:i}}angular.module("taskingManager").service("statsService",["$http","$q","configService",e])}(),function(){function e(){function e(e){var t=e.get("taskStatus"),r=null;if("LOCKED_FOR_MAPPING"===t)r=d;else if("LOCKED_FOR_VALIDATION"===t)r=g;else if("READY"===t)r=s;else if("INVALIDATED"===t)r=c;else if("MAPPED"===t)r=l;else if("VALIDATED"===t)r=u;else{if("BADIMAGERY"!==t)return i;r=p}return new ol.style.Style({fill:new ol.style.Fill({color:r}),stroke:new ol.style.Stroke({color:f,width:m})})}function t(){return new ol.style.Style({fill:new ol.style.Fill({color:[225,225,225,0]}),stroke:new ol.style.Stroke({color:[0,0,0,1],width:4})})}function r(){return new ol.style.Style({fill:new ol.style.Fill({color:[18,89,240,0]}),stroke:new ol.style.Stroke({color:[18,89,240,1],width:4})})}function n(t){var r=e(t);return r.getStroke().setColor(h),r.getStroke().setWidth(v),r}function a(e){var t=[255,0,0,.5],r=[0,0,0,1];e&&("red"===e&&(t=[255,0,0,.5],r=[0,0,0,1]),"orange"===e&&(t=[255,165,0,.5],r=[0,0,0,1]),"yellow"===e&&(t=[255,255,0,.5],r=[0,0,0,1]),"blue"===e&&(t=[0,0,255,.5],r=[0,0,0,1]),"black"===e&&(t=[0,0,0,.5],r=[0,0,0,1]));var n=new ol.style.Fill({color:t,width:1}),a=new ol.style.Stroke({color:r,width:1});return new ol.style.Style({fill:n,stroke:a,image:new ol.style.Circle({fill:n,stroke:a,radius:5})})}function o(){var e=new ol.style.Fill({color:[255,0,0,1],width:1}),t=new ol.style.Stroke({color:[255,0,0,1],width:1});return new ol.style.Style({image:new ol.style.Circle({fill:e,stroke:t,radius:8})})}var i=new ol.style.Style({fill:new ol.style.Fill({color:[250,250,250,1]}),stroke:new ol.style.Stroke({color:[220,220,220,1],width:1})}),s=[223,223,223,.1],c=[233,11,67,.4],l=[255,198,12,.4],u=[0,128,0,.4],d=[18,89,240,.4],g=[18,89,240,.4],p=[0,0,0,.4],f=[84,84,84,.7],m=1,h=[255,255,0,1],v=2;return{getTaskStyle:e,getSelectedTaskStyle:n,getHighlightedTaskStyle:t,getStyleWithColour:a,getHighlightedProjectStyle:o,getLockedByCurrentUserTaskStyle:r}}angular.module("taskingManager").service("styleService",[e])}(),function(){function e(e,t,r){function n(){return e({method:"GET",url:r.tmAPI+"/tags/organisations"}).then(function(e){return e.data},function(){return t.reject("error")})}function a(){return e({method:"GET",url:r.tmAPI+"/tags/campaigns"}).then(function(e){return e.data},function(){return t.reject("error")})}return{getOrganisationTags:n,getCampaignTags:a}}angular.module("taskingManager").service("tagService",["$http","$q","configService",e])}(),function(){function e(e,t,r,n){function a(a,o){var i={"Content-Type":"application/json; charset=UTF-8"},s=n.getAuthenticatedHeader();return s&&(i=s),e({method:"GET",url:r.tmAPI+"/project/"+a+"/task/"+o,headers:i}).then(function(e){return e.data},function(){return t.reject("error")})}function o(a,o,i,s){return e({method:"POST",data:{comment:i,status:s},url:r.tmAPI+"/project/"+a+"/task/"+o+"/unlock-after-mapping",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(e){return t.reject(e)})}function i(a,o,i){return e({method:"POST",data:{comment:i},url:r.tmAPI+"/project/"+a+"/task/"+o+"/stop-mapping",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(e){return t.reject(e)})}function s(a,o){return e({method:"POST",url:r.tmAPI+"/project/"+a+"/task/"+o+"/lock-for-mapping",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(e){return t.reject(e)})}function c(a,o){return e({method:"POST",data:{validatedTasks:o},url:r.tmAPI+"/project/"+a+"/unlock-after-validation",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data.tasks},function(e){return t.reject(e)})}function l(a,o){return e({method:"POST",data:{resetTasks:o},url:r.tmAPI+"/project/"+a+"/stop-validating",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data.tasks},function(e){return t.reject(e)})}function u(a,o){return e({method:"POST",data:{taskIds:o},url:r.tmAPI+"/project/"+a+"/lock-for-validation",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data.tasks},function(e){return t.reject(e)})}function d(e){if(e&&e instanceof Array&&e.length>0){var t=[],t=p(e,"READY");if(0==t.length&&(t=p(e,"INVALIDATED")),t.length>0)return t[Math.floor(Math.random()*(t.length-1))]}return null}function g(e){if(e&&e instanceof Array&&e.length>0){var t=[],t=p(e,"MAPPED");if(t.length>0)return t[Math.floor(Math.random()*(t.length-1))]}return null}function p(e,t){if(r=[],e&&e instanceof Array&&e.length>0)var r=e.filter(function(e){if(e instanceof ol.Feature){if(e.get("taskStatus")===t)return e}});return r}function f(e,t){if(r=[],e&&e instanceof Array&&e.length>0)var r=e.filter(function(e){if(e instanceof ol.Feature){if(e.get("taskId")==t)return e}});return r.length>0?r[0]:null}function m(e,t){if(r=[],
e&&e instanceof Array&&e.length>0)var r=e.filter(function(e){if(e instanceof ol.Feature){var r=e.get("taskId"),n=t.indexOf(r);if(-1!==n)return t[n]}});return r.length>0?r:null}function h(e,t,r){if(n=[],e&&e instanceof Array&&e.length>0)var n=e.filter(function(e){if(e instanceof ol.Feature){var n=e.get("taskId"),a=e.get("taskStatus");if(-1!==t.indexOf(n)&&a===r)return e}});return n}function v(n){return e({method:"GET",url:r.tmAPI+"/project/"+n+"/mapped-tasks-by-user",headers:{"Content-Type":"application/json; charset=UTF-8"}}).then(function(e){return e.data},function(){return t.reject("error")})}function S(a){return e({method:"GET",url:r.tmAPI+"/project/"+a+"/has-user-locked-tasks",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data.lockedTasks},function(){return t.reject("error")})}function k(a){return e({method:"GET",url:r.tmAPI+"/project/"+a+"/has-user-locked-tasks/details",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data.tasks},function(){return t.reject("error")})}function y(a,o){return e({method:"POST",url:r.tmAPI+"/project/"+a+"/task/"+o+"/split",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(e){return t.reject(e)})}function j(a,o){return e({method:"POST",url:r.tmAPI+"/project/"+a+"/task/"+o+"/undo-mapping",headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(e){return t.reject(e)})}return{getTask:a,unLockTaskMapping:o,stopMapping:i,lockTaskMapping:s,unLockTaskValidation:c,stopValidating:l,lockTasksValidation:u,getRandomMappableTaskFeature:d,getRandomTaskFeatureForValidation:g,getTasksByStatus:p,getTaskFeatureById:f,getTaskFeaturesByIds:m,getMappedTasksByUser:v,getLockedTasksForCurrentUser:S,getLockedTaskDetailsForCurrentUser:k,splitTask:y,getTaskFeaturesByIdAndStatus:h,undo:j}}angular.module("taskingManager").service("taskService",["$http","$q","configService","authService",e])}(),function(){function e(e,t,r,n){function a(a,o){return e({method:"POST",url:r.tmAPI+"/user/"+a+"/set-role/"+o,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function o(a,o){return e({method:"POST",url:r.tmAPI+"/user/"+a+"/set-level/"+o,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function i(n){return e({method:"GET",url:r.tmAPI+"/user/"+n+"/osm-details",headers:{"Content-Type":"application/json; charset=UTF-8"}}).then(function(e){return e.data},function(){return t.reject("error")})}function s(n){return e({method:"GET",url:r.tmAPI+"/user/"+n+"/mapped-projects",headers:{"Content-Type":"application/json; charset=UTF-8"}}).then(function(e){return e.data},function(){return t.reject("error")})}function c(n){return e({method:"GET",url:r.tmAPI+"/user/search/filter/"+n,headers:{"Content-Type":"application/json; charset=UTF-8"}}).then(function(e){return e.data},function(){return t.reject("error")})}function l(n,a,o,i){var s="";return s+=n?"page="+n:"page=1",a&&(s+="&role="+a),o&&(s+="&level="+o),i&&(s+="&username="+i),e({method:"GET",url:r.tmAPI+"/user/search-all?"+s,headers:{"Content-Type":"application/json; charset=UTF-8"}}).then(function(e){return e.data},function(){return t.reject("error")})}function u(a){return e({method:"POST",url:r.tmAPI+"/user/accept-license/"+a,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}function d(a){return e({method:"POST",url:r.tmAPI+"/user/update-details",data:a,headers:n.getAuthenticatedHeader()}).then(function(e){return e.data},function(){return t.reject("error")})}return{setRole:a,setLevel:o,getOSMUserDetails:i,getUserProjects:s,searchUser:c,searchAllUsers:l,acceptLicense:u,setContactDetails:d}}angular.module("taskingManager").service("userService",["$http","$q","configService","authService",e])}(),function(){function e(){function e(){localStorage.getItem(s)?i=JSON.parse(localStorage.getItem(s)):localStorage.setItem(s,JSON.stringify(i))}function t(){return s}function r(){return i.favouriteEditor}function n(e){i.favouriteEditor=e,localStorage.setItem(s,JSON.stringify(i))}function a(){return i.language}function o(e){i.language=e,localStorage.setItem(s,JSON.stringify(i))}var i={favouriteEditor:"ideditor",language:""},s="hottm-user-preferences";return{initialise:e,getlocalStorageUserPreferencesName:t,getFavouriteEditor:r,setFavouriteEditor:n,getLanguage:a,setLanguage:o}}angular.module("taskingManager").service("userPreferencesService",["$window",e])}(),function(){function e(e,t,r,n,a,o,i,s){function c(e){if(e){var t=a.validateAOI(e);t.valid?l(e):"CONTAINS_NON_POLYGON_FEATURES"==t.message?d.nonPolygonError=!0:"SELF_INTERSECTIONS"==t.message&&(d.selfIntersectionError=!0)}}function l(e){d.isImportedAOI=!0,d.isDrawnAOI=!1,a.setAOI(e),n.getSource().addFeatures(e),d.map.getView().fit(n.getSource().getExtent())}function u(e){d.drawAndSelectPolygon&&d.drawAndSelectPolygon.setActive(e),d.drawAndSelectPoint&&d.drawAndSelectPoint.setActive(e)}var d=this;d.map=null,d.currentStep="",d.projectName="",d.projectNameForm={},d.taskType="square-grid",d.AOI=null,d.isDrawnAOI=!1,d.isImportedAOI=!1,d.clipTasksToAoi=!0,d.isTaskGrid=!1,d.isTaskArbitrary=!1,d.sizeOfTasks=0,d.MAX_SIZE_OF_TASKS=1e3,d.numberOfTasks=0,d.MAX_NUMBER_OF_TASKS_SPLIT=1500,d.DEFAULT_ZOOM_LEVEL_OFFSET=2,d.initialZoomLevelForTaskGridCreation=0,d.userZoomLevelOffset=0,d.isAOIValid=!1,d.AOIValidationMessage="",d.isSplitPolygonValid=!0,d.splitPolygonValidationMessage="",d.isimportError=!1,d.nonPolygonError=!1,d.selfIntersectionError=!1,d.createProjectFail=!1,d.createProjectFailReason="",d.createProjectSuccess=!1,d.drawAndSelectPolygon=null,d.drawAndSelectPoint=null,d.modifyInteraction=null,d.drawPolygonInteraction=null,d.waiting=!1,d.trimError=!1,d.trimErrorReason="",function(){d.cloneProjectId=t.search().projectId,d.cloneProjectName=t.search().projectName,d.cloneProjectId&&(d.isCloneProject=!0,t.search("projectId",null),t.search("projectName",null));var e=s.getSession();e&&i.getUser(e.username).then(function(e){"PROJECT_MANAGER"!==e.role&&"ADMIN"!==e.role&&t.path("/")},function(){t.path("/")}),d.currentStep="area",r.createOSMMap("map"),r.addGeocoder(),d.map=r.getOSMMap(),n.initInteractions(!0,!1,!1,!1,!1,!0),d.modifyInteraction=n.getModifyInteraction(),d.drawPolygonInteraction=n.getDrawPolygonInteraction(),d.drawPolygonInteraction.on("drawstart",function(){n.getSource().clear()}),a.initDraw(d.map)}(),d.setWizardStepAfterTaskTypeSelection=function(){"square-grid"===d.taskType?(d.createTaskGrid(),d.setWizardStep("taskSize")):"arbitrary-tasks"===d.taskType&&(d.createArbitaryTasks(),d.setWizardStep("review"))},d.setWizardStep=function(e){if("area"===e)d.isTaskGrid=!1,d.isTaskArbitrary=!1,a.removeTaskGrid(),d.currentStep=e,d.isDrawnAOI&&(d.drawPolygonInteraction.setActive(!0),d.modifyInteraction.setActive(!0));else if("tasks"===e){if(u(!1),d.zoomLevelForTaskGridCreation=r.getOSMMap().getView().getZoom()+d.DEFAULT_ZOOM_LEVEL_OFFSET,d.userZoomLevelOffset=0,d.isDrawnAOI){var t=a.validateAOI(n.getSource().getFeatures());d.isAOIValid=t.valid,d.AOIValidationMessage=t.message,d.isAOIValid&&(d.map.getView().fit(n.getSource().getExtent()),d.currentStep=e,d.drawPolygonInteraction.setActive(!1),d.modifyInteraction.setActive(!1))}d.isImportedAOI&&(d.drawPolygonInteraction.setActive(!1),d.map.getView().fit(n.getSource().getExtent()),d.currentStep=e,d.drawPolygonInteraction.setActive(!1),d.modifyInteraction.setActive(!1))}else if("taskSize"===e){var o=a.getTaskGrid();o&&(d.currentStep=e)}else"trim"===e?(d.trimError=!1,d.trimErrorReason="",d.currentStep=e):"review"===e?(u(!1),d.createProjectFailed=!1,d.createProjectFailReason="",d.currentStep=e):d.currentStep=e},d.showWizardStep=function(e){var t=!1;return"area"===e?"area"!==d.currentStep&&"tasks"!==d.currentStep&&"taskSize"!==d.currentStep&&"trim"!==d.currentStep&&"review"!==d.currentStep||(t=!0):"tasks"===e?"tasks"!==d.currentStep&&"taskSize"!==d.currentStep&&"trim"!==d.currentStep&&"review"!==d.currentStep||(t=!0):"taskSize"===e?"taskSize"!==d.currentStep&&"trim"!==d.currentStep&&"review"!==d.currentStep||(t=!0):"trim"===e?"trim"!==d.currentStep&&"review"!==d.currentStep||(t=!0):"review"===e?"review"===d.currentStep&&(t=!0):t=!1,t},d.drawAOI=function(){d.drawPolygonInteraction.setActive(!0),d.isDrawnAOI=!0,d.isImportedAOI=!1},d.trimTaskGrid=function(){a.getTaskGrid();d.waiting=!0,a.trimTaskGrid(d.clipTasksToAoi).then(function(e){d.waiting=!1,d.trimError=!1,d.trimErrorReason="",a.removeTaskGrid();var t=o.getFeaturesFromGeoJSON(e,"EPSG:3857");a.setTaskGrid(t),a.addTaskGridToMap(),d.numberOfTasks=a.getNumberOfTasks()},function(e){d.waiting=!1,d.trimError=!0,d.trimErrorReason=e.status})},d.createArbitaryTasks=function(){if(d.isImportedAOI){d.isTaskGrid=!1,d.isTaskArbitrary=!0,a.removeTaskGrid();var e=n.getSource().getFeatures();a.setAOI(e),d.numberOfTasks=n.getSource().getFeatures().length}},d.createTaskGrid=function(){d.isTaskGrid=!0,d.isTaskArbitrary=!1,a.removeTaskGrid();var e=n.getSource().getFeatures();if(a.setAOI(e),d.isDrawnAOI||d.isImportedAOI){var t=n.getSource().getExtent(),r=a.createTaskGrid(t,d.zoomLevelForTaskGridCreation+d.userZoomLevelOffset);a.setTaskGrid(r),a.addTaskGridToMap(),d.numberOfTasks=a.getNumberOfTasks(),d.sizeOfTasks=a.getTaskSize()}},d.changeSizeTaskGrid=function(e){d.userZoomLevelOffset+=e,d.createTaskGrid()},d.import=function(e){if(d.drawPolygonInteraction.setActive(!1),d.isimportError=!1,d.nonPolygonError=!1,d.selfIntersectionError=!1,e){n.getSource().clear();var t=new FileReader;t.onloadend=function(t){var r=t.target.result,n=null;"json"===e.name.substr(-4).toLowerCase()?(n=o.getFeaturesFromGeoJSON(r),c(n)):"kml"===e.name.substr(-3).toLowerCase()?(n=o.getFeaturesFromKML(r),c(n)):"zip"===e.name.substr(-3).toLowerCase()&&shp(r).then(function(e){c(o.getFeaturesFromGeoJSON(e))})},"json"===e.name.substr(-4).toLowerCase()?t.readAsText(e):"kml"===e.name.substr(-3).toLowerCase()?t.readAsText(e):"zip"===e.name.substr(-3).toLowerCase()?t.readAsArrayBuffer(e):(d.isImportError=!0,d.nonPolygonError=!1,d.selfIntersectionError=!1)}},d.drawAndSplitAreaPolygon=function(){if(u(!1),!d.drawAndSelectPolygon){var t=r.getOSMMap();d.drawAndSelectPolygon=new ol.interaction.Draw({type:"Polygon"}),t.addInteraction(d.drawAndSelectPolygon),d.drawAndSelectPolygon.on("drawend",function(t){var r=a.validateAOI([t.feature]);e.$apply(function(){d.isSplitPolygonValid=r.valid,d.splitPolygonValidationMessage=r.message,d.isSplitPolygonValid&&(a.splitTasks(t.feature),d.numberOfTasks=a.getNumberOfTasks())})})}d.drawAndSelectPolygon.setActive(!0)},d.drawAndSplitAreaPoint=function(){if(u(!1),!d.drawAndSelectPoint){var t=r.getOSMMap();d.drawAndSelectPoint=new ol.interaction.Draw({type:"Point"}),t.addInteraction(d.drawAndSelectPoint),d.drawAndSelectPoint.on("drawend",function(t){e.$apply(function(){a.splitTasks(t.feature),d.numberOfTasks=a.getNumberOfTasks()})})}d.drawAndSelectPoint.setActive(!0)},d.createProject=function(){var e=null;if(d.isCloneProject&&(e=d.cloneProjectId),d.createProjectFail=!1,d.createProjectSuccess=!1,d.projectNameForm.$valid){d.waiting=!0;a.createProject(d.projectName,d.isTaskGrid,e).then(function(e){d.waiting=!1,d.createProjectFail=!1,d.createProjectSuccess=!0,d.createProjectFailReason="",t.path("/admin/edit-project/"+e.projectId)},function(e){d.waiting=!1,d.createProjectFail=!0,d.createProjectSuccess=!1,d.createProjectFailReason=e.status})}else d.projectNameForm.submitted=!0},d.toggleClipTasksToAoi=function(){d.clipTasksToAoi=!d.clipTasksToAoi}}angular.module("taskingManager").controller("createProjectController",["$scope","$location","mapService","drawService","projectService","geospatialService","accountService","authService",e])}(),function(){function e(e,t,r){function n(){o.errorReturningProjects=!1,r.getMyProjects().then(function(e){o.projects=e,a(o.projects)},function(){o.errorReturningProjects=!0,o.projects={}})}function a(e){e.activeProjects&&t.showProjectsOnMap(e.activeProjects,"red",!1),e.draftProjects&&t.showProjectsOnMap(e.draftProjects,"blue",!0),e.archivedProjects&&t.showProjectsOnMap(e.archivedProjects,"black",!0)}var o=this;o.projects={},o.selectedProject={},o.mappedData=[],o.mappedLabels=[],o.validatedData=[],o.validatedLabels=[],o.projectComments=[],o.searchText="",o.propertyName="id",o.reverse=!1,o.showActive=!0,o.showDraft=!1,o.showArchived=!1,o.errorReturningProjects=!1,function(){e.createOSMMap("map"),o.map=e.getOSMMap(),n()}(),o.sortBy=function(e){o.reverse=o.propertyName===e&&!o.reverse,o.propertyName=e},o.toggleActive=function(){o.showActive=!o.showActive},o.toggleDraft=function(){o.showDraft=!o.showDraft},o.toggleArchived=function(){o.showArchived=!o.showArchived}}angular.module("taskingManager").controller("dashboardController",["mapService","projectMapService","projectService",e])}(),function(){function e(e,t,r,n,a,o,i,s,c,l,u,d,g,p,f){function m(){C.nameMissing=!1,C.descriptionMissing=!1,C.shortDescriptionMissing=!1,C.instructionsMissing=!1,C.instructionsMissing=!1;for(var e=0;e<C.project.projectInfoLocales.length;e++)if(C.project.projectInfoLocales[e].locale===C.project.defaultLocale){var t=C.project.projectInfoLocales[e];void 0!==t.name&&""!==t.name||(C.nameMissing=!0),void 0!==t.description&&""!==t.description||(C.descriptionMissing=!0),void 0!==t.shortDescription&&""!==t.shortDescription||(C.shortDescriptionMissing=!0),void 0!==t.instructions&&""!==t.instructions||(C.instructionsMissing=!0);break}return C.name||C.descriptionMissing||C.shortDescriptionMissing||C.instructionsMissing}function h(){C.editPriority=!1,C.deletePriority=!1,C.selectInteraction.getFeatures().clear(),C.drawPolygonInteraction&&C.drawPolygonInteraction.setActive(!1),C.drawRectangleInteraction&&C.drawRectangleInteraction.setActive(!1),C.drawCircleInteraction&&C.drawCircleInteraction.setActive(!1),C.selectInteraction&&C.selectInteraction.setActive(!1),C.modifyInteraction&&C.modifyInteraction.setActive(!1),C.translateInteraction&&C.translateInteraction.setActive(!1)}function v(){C.selectInteraction.on("select",function(e){var t=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,255,255,0.6)"}),stroke:new ol.style.Stroke({color:"rgba(255,0,0,1)",width:1})}),r=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,255,255,0.6)"}),stroke:new ol.style.Stroke({color:"rgba(255,0,0,1)",width:3})});if(e.selected[0]&&e.selected[0].setStyle(r),e.deselected[0]&&e.deselected[0].setStyle(t),C.translateInteraction.getActive());else{var n=C.source.getFeaturesAtCoordinate(e.mapBrowserEvent.coordinate);n&&(C.source.removeFeature(n[0]),C.selectInteraction.getFeatures().clear())}})}function S(){C.source.on("addfeature",function(t){var r=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,255,255,0.6)"}),stroke:new ol.style.Stroke({color:"rgba(255,0,0,1)",width:1})});t.feature.setStyle(r),n(function(){e.$apply(C.numberOfPriorityAreas++)})}),C.source.on("removefeature",function(){n(function(){e.$apply(C.numberOfPriorityAreas--)})})}function k(e){C.errorReturningProjectMetadata=!1,i.getProjectMetadata(e).then(function(e){C.source.clear(),C.project=e,y();for(var t=0;t<C.locales.length;t++){for(var r=!1,n=0;n<C.project.projectInfoLocales.length;n++)if(C.locales[t]===C.project.projectInfoLocales[n].locale){r=!0;break}if(!r){var a={locale:C.locales[t],name:"",shortDescription:"",description:"",instructions:"",perTaskInstructions:""};C.project.projectInfoLocales.push(a)}}C.project.dueDate&&(C.project.dueDate=new Date(C.project.dueDate)),I(),T(),w(),C.project.organisationTag&&(C.projectOrganisationTag=[C.project.organisationTag]),C.project.campaignTag&&(C.projectCampaignTag=[C.project.campaignTag])},function(){C.errorReturningProjectMetadata=!0})}function y(){d.getLicenseList().then(function(e){if(C.licenses=e.licenses,C.licenses)for(var t=0;t<C.licenses.length;t++)if(C.licenses[t].licenseId===C.project.licenseId){C.projectLicense=C.licenses[t];break}},function(){})}function j(){o.initInteractions(!0,!0,!0,!0,!0,!0),C.source=o.getSource(),C.modifyInteraction=o.getModifyInteraction(),C.drawPolygonInteraction=o.getDrawPolygonInteraction(),C.drawRectangleInteraction=o.getDrawRectangleInteraction(),C.drawCircleInteraction=o.getDrawCircleInteraction(),C.selectInteraction=o.getSelectInteraction(),C.translateInteraction=o.getTranslateInteraction(),v(),S()}function T(){var e=new ol.source.Vector,t=new ol.layer.Vector({source:e});C.map.addLayer(t);var r=s.getFeaturesFromGeoJSON(C.project.areaOfInterest);e.addFeatures(r),C.map.getView().fit(e.getExtent())}function w(){if(C.project.priorityAreas)for(var e=0;e<C.project.priorityAreas.length;e++){var t=s.getFeatureFromGeoJSON(C.project.priorityAreas[e]);C.source.addFeature(t)}}function I(){C.project.mappingTypes&&(-1!=C.project.mappingTypes.indexOf("ROADS")&&(C.mappingTypes.roads=!0),-1!=C.project.mappingTypes.indexOf("BUILDINGS")&&(C.mappingTypes.buildings=!0),-1!=C.project.mappingTypes.indexOf("WATERWAYS")&&(C.mappingTypes.waterways=!0),-1!=C.project.mappingTypes.indexOf("LAND_USE")&&(C.mappingTypes.landuse=!0),-1!=C.project.mappingTypes.indexOf("OTHER")&&(C.mappingTypes.other=!0))}function A(){var e=[];return C.mappingTypes.roads&&e.push("ROADS"),C.mappingTypes.buildings&&e.push("BUILDINGS"),C.mappingTypes.waterways&&e.push("WATERWAYS"),C.mappingTypes.landuse&&e.push("LAND_USE"),C.mappingTypes.other&&e.push("OTHER"),e}function P(){u.getOrganisationTags().then(function(e){C.organisationTags=e.tags},function(){C.organisationTags=[]})}function L(){u.getCampaignTags().then(function(e){C.campaignTags=e.tags},function(){C.campaignTags=[]})}function M(){for(var e="",t=C.project.projectInfoLocales,r=0;r<t.length;r++)if(t[r].locale===C.project.defaultLocale)return e=t[r].name;return e}var C=this;C.currentSection="",C.editForm={},C.map=null,C.modifyInteraction=null,C.drawPolygonInteraction=null,C.drawRectangleInteraction=null,C.drawCircleInteraction=null,C.selectInteraction=null,C.editPriority=!1,C.deletePriority=!1,C.numberOfPriorityAreas=0,C.locales=[],C.mappingTypes={buildings:!1,roads:!1,waterways:!1,landuse:!1,other:!1},C.organisationTags=[],C.campaignsTags=[],C.projectOrganisationTag=[],C.projectCampaignTag=[],C.project={},C.project.defaultLocale="en",C.descriptionLanguage="en",C.shortDescriptionLanguage="en",C.nameLanguage="en",C.instructionsLanguage="en",C.perTaskInstructionsLanguage="en",C.descriptionHTML="",C.showDeleteConfirmationModal=!1,C.addUserEnabled=!1,C.deleteProjectFail=!1,C.deleteProjectSuccess=!1,C.invalidateTasksFail=!1,C.invalidateTasksSuccess=!1,C.validateTasksFail=!1,C.validateTasksSuccess=!1,C.messageSubject="",C.messageContent="",C.form={},function(){var e=f.getSettings();e.then(function(e){for(var t=0;t<e.supportedLanguages.length;t++)C.locales.push(e.supportedLanguages[t].code)});var n=l.getSession();if(n){var e=c.getUser(n.username);e.then(function(e){"PROJECT_MANAGER"!==e.role&&"ADMIN"!==e.role&&t.path("/")},function(){t.path("/")})}var o=r.id;a.createOSMMap("map"),C.map=a.getOSMMap(),j(),P(),L(),k(o),C.currentSection="description"}(),C.saveEdits=function(){for(var e=C.source.getFeatures(),t=[],r=0;r<e.length;r++){var n=s.getGeoJSONObjectFromFeature(e[r]);t.push(n.geometry)}if(C.project.priorityAreas=t,C.updateProjectFail=!1,C.updateProjectSuccess=!1,"PUBLISHED"===C.project.projectStatus)var a=m();if(delete C.project.areaOfInterest,C.project.organisationTag=null,C.project.campaignTag=null,C.projectOrganisationTag[0]&&(C.project.organisationTag=C.projectOrganisationTag[0].text),C.projectCampaignTag[0]&&(C.project.campaignTag=C.projectCampaignTag[0].text),C.projectLicense?C.project.licenseId=C.projectLicense.licenseId:C.project.licenseId=null,!a&&C.editForm.$valid){C.project.mappingTypes=A(),C.project.josmPreset=C.josmPreset;for(var r=0;r<C.project.projectInfoLocales.length;r++){var o=C.project.projectInfoLocales[r],c=!1;""===o.description&&""===o.shortDescription&&""===o.name&&""===o.instructions&&""==o.perTaskInstructions||(c=!0),c||(C.project.projectInfoLocales.splice(r,1),r--)}i.updateProject(C.project.projectId,C.project).then(function(e){C.updateProjectFail=!1,C.updateProjectSuccess=!0,k(C.project.projectId)},function(){C.updateProjectFail=!0,C.updateProjectSuccess=!1})}},C.changeLanguageDescription=function(e){C.descriptionLanguage=e},C.changeLanguageName=function(e){C.nameLanguage=e},C.changeLanguageShortDescription=function(e){C.shortDescriptionLanguage=e},C.changeLanguageInstructions=function(e){C.instructionsLanguage=e},C.changeLanguagePerTaskInstructions=function(e){C.perTaskInstructionsLanguage=e},C.changeDefaultLocale=function(e){C.project.defaultLocale=e,C.nameMissing=!1,C.descriptionMissing=!1,C.shortDescriptionMissing=!1,C.instructionsMissing=!1},C.drawPriorityPolygon=function(){h(),C.drawPolygonInteraction.setActive(!0)},C.drawPriorityRectangle=function(){h(),C.drawRectangleInteraction.setActive(!0)},C.drawPriorityCircle=function(){h(),C.drawCircleInteraction.setActive(!0)},C.editPriorityArea=function(){h(),C.editPriority=!0,C.selectInteraction.setActive(!0),C.modifyInteraction.setActive(!0),C.translateInteraction.setActive(!0)},C.deletePriorityArea=function(){h(),C.deletePriority=!0,C.selectInteraction.setActive(!0)},C.clearAllPriorityAreas=function(){h(),C.source.clear()},C.setMapperLevel=function(e){C.project.mapperLevel=e},C.goToHome=function(){t.path("/")},C.showDeleteConfirmation=function(e){C.showDeleteConfirmationModal=e,!e&&C.deleteProjectSuccess&&t.path("/")},C.deleteProject=function(){C.deleteProjectFail=!1,C.deleteProjectSuccess=!1,i.deleteProject(C.project.projectId).then(function(){C.deleteProjectFail=!1,C.deleteProjectSuccess=!0,k(C.project.projectId)},function(){C.deleteProjectFail=!0,C.deleteProjectSuccess=!1})},C.showInvalidateConfirmation=function(e){C.showInvalidateConfirmationModal=e},C.invalidateAllTasks=function(){C.invalidateInProgress=!0,C.invalidateTasksFail=!1,C.invalidateTasksSuccess=!1,i.invalidateAllTasks(C.project.projectId).then(function(){C.invalidateTasksFail=!1,C.invalidateTasksSuccess=!0,C.invalidateInProgress=!1},function(){C.invalidateTasksFail=!0,C.invalidateTasksSuccess=!1,C.invalidateInProgress=!1})},C.showValidateConfirmation=function(e){C.showValidateConfirmationModal=e},C.validateAllTasks=function(){C.validateInProgress=!0,C.validateTasksFail=!1,C.validateTasksSuccess=!1,i.validateAllTasks(C.project.projectId).then(function(){C.validateTasksFail=!1,C.validateTasksSuccess=!0,C.validateInProgress=!1},function(){C.validateTasksFail=!0,C.validateTasksSuccess=!1,C.validateInProgress=!1})},C.showMessageContributors=function(e){C.showMessageContributorsModal=e},C.sendMessage=function(){C.sendMessageInProgress=!0,C.sendMessageFail=!1,p.messageAll(C.project.projectId,C.messageSubject,C.messageContent).then(function(){C.sendMessageFail=!1,C.sendMessageInProgress=!1,C.messageSubject="",C.messageContent="",C.showMessageContributorsModal=!1},function(){C.sendMessageFail=!0,C.sendMessageInProgress=!1})},C.getOrganisationTags=function(e){return C.organisationTags.filter(function(t){return t&&t.toLowerCase().indexOf(e.toLowerCase())>-1})},C.getCampaignTags=function(e){return C.campaignTags.filter(function(t){return t&&t.toLowerCase().indexOf(e.toLowerCase())>-1})},C.getUser=function(e){return g.searchUser(e).then(function(e){return e.usernames},function(){})},C.addUser=function(e){-1==C.project.allowedUsernames.indexOf(e)&&C.project.allowedUsernames.push(e)},C.removeUser=function(e){var t=C.project.allowedUsernames.indexOf(e);t>-1&&C.project.allowedUsernames.splice(t,1)},C.onPrivateChange=function(){C.project.private||(C.project.allowedUsernames=[])},C.enableAddUser=function(e){C.addUserEnabled=e},C.cloneProject=function(){t.path("/admin/create-project").search({projectId:C.project.projectId,projectName:M()})}}angular.module("taskingManager").controller("editProjectController",["$scope","$location","$routeParams","$timeout","mapService","drawService","projectService","geospatialService","accountService","authService","tagService","licenseService","userService","messageService","settingsService",e])}(),function(){function e(e,t,r){var n=this;n.license={},n.isNew=!1,n.isLicenseFound=!1,n.isSaveEditsSuccessful=!0,n.isDeleteSuccessful=!0,n.isCreateNewSuccessful=!0,n.id=0,function(){n.id=e.id,"new"===n.id?n.isNew=!0:r.getLicense(n.id).then(function(e){n.license=e,n.isLicenseFound=!0},function(){n.isLicenseFound=!1})}(),n.cancel=function(){t.path("/admin/licenses")},n.saveEdits=function(){n.isSaveEditsSuccessful=!0,r.updateLicense(n.license,n.id).then(function(){t.path("/admin/licenses")},function(){n.isSaveEditsSuccessful=!1})},n.delete=function(){n.isDeleteSuccessful=!0,r.deleteLicense(n.id).then(function(){t.path("/admin/licenses")},function(){n.isDeleteSuccessful=!1})},n.createNewLicense=function(){n.isCreateNewSuccessful=!0,r.createLicense(n.license).then(function(){t.path("/admin/licenses")},function(){n.isCreateNewSuccessful=!1})}}angular.module("taskingManager").controller("licenseEditController",["$routeParams","$location","licenseService",e])}(),function(){function e(e,t){var r=this;r.licenses=[],function(){t.getLicenseList().then(function(e){r.licenses=e.licenses},function(){})}(),r.createNewLicense=function(){e.path("/admin/licenses/edit/new")}}angular.module("taskingManager").controller("licensesController",["$location","licenseService",e])}(),function(){function e(e,t,r,n,a){function o(e,t,r,a){i.errorGetUsers=!1;var o=e||1,s=t||"",c=r||"",l=a||"";n.searchAllUsers(o,s,c,l).then(function(e){i.users=e.users,i.pagination=e.pagination},function(){i.errorGetUsers=!0})}var i=this;i.searchText={},i.itemsPerPage=5,i.currentPage=1,i.pagination={},i.role="",i.level="",i.username="",i.page=1,i.errorGetUsers=!1,i.locale="en",i.users=[],function(){o(1,"","",""),i.locale=r.use()}(),e.$watch(function(){return a.getLanguageCode()},function(){i.locale=r.use()},!0),i.searchUsers=function(){o(i.page,i.role,i.level,i.username)},i.searchUsersWithPage=function(e){o(e,i.role,i.level,i.username)},i.selectUser=function(e){t.path("/user/"+e)}}angular.module("taskingManager").controller("usersController",["$scope","$location","$translate","userService","languageService",e])}(),function(){function e(){return{restrict:"EA",templateUrl:"app/components/account-nav/account-nav.html",controller:"accountNavController",controllerAs:"accountNavCtrl",bindToController:!0}}function t(e,t,r,n,a,o,i,s,c,l){function u(){l.hasNewMessages().then(function(e){d.userMessages=e},function(){})}var d=this;d.account={},d.showDropdown=!1,d.userMessages=null,d.newMessageNotification=!0,e.$watch(function(){return s.getAccount()},function(e){d.account=e,d.account.username&&u()},!0),o(function(){d.newMessageNotification=!1},1e4),function(){r(function(){d.account.username&&u()},1e4),n.bind("click",function(t){a.find(t.target).length>0||(d.showDropdown=!1,e.$apply())})}(),d.login=function(){c.login()},d.logout=function(){c.logout(),t.path("/"),d.showDropdown=!1,s.setAccount(null)},d.goToProfile=function(){t.path("user/"+d.account.username),d.showDropdown=!1},d.goToCreateNewProject=function(){i.reload(),t.path("admin/create-project"),d.showDropdown=!1},d.goToManageLicenses=function(){t.path("admin/licenses"),d.showDropdown=!1},d.goToProjectDashboard=function(){t.path("admin/dashboard"),d.showDropdown=!1},d.goToUserList=function(){t.path("admin/users"),d.showDropdown=!1},d.goToMessages=function(){t.path("inbox"),d.showDropdown=!1},d.hideNotification=function(){d.newMessageNotification=!1},d.toggleMenu=function(e){d.showDropdown=!d.showDropdown,e.stopPropagation()}}angular.module("taskingManager").controller("accountNavController",["$scope","$location","$interval","$document","$element","$timeout","$route","accountService","authService","messageService",t]).directive("accountNav",e)}(),function(){function e(){return{restrict:"EA",templateUrl:"app/components/add-layer/add-layer.html",controller:"addLayerController",controllerAs:"addLayerCtrl",bindToController:!0}}function t(e){var t=this;t.type="xyz",t.layerURL="",t.layerName="",t.isVisible=!1,t.addLayer=function(){t.layerURL&&("xyz"===t.type&&e.addXYZLayer(t.type+" (temporary)",t.layerURL,"",!0),"wms"===t.type&&e.addTiledWMSLayer(t.type+" (temporary)",t.layerURL,t.layerName,"",!0))},t.toggleVisibility=function(){t.isVisible=!t.isVisible}}angular.module("taskingManager").controller("addLayerController",["mapService",t]).directive("addLayer",e)}(),function(){function e(){return{restrict:"EA",templateUrl:"app/components/language/language-switch.html",controller:"languageSwitchController",controllerAs:"languageSwitchCtrl",bindToController:!0}}function t(e,t,r,n,a,o,i){var s=this;s.showDropdown=!1,s.selectedLanguage="English",s.availableLanguages=[],function(){o.getSettings().then(function(e){s.availableLanguages=e.supportedLanguages;var t=i.getLanguage();t&&(s.selectedLanguage=t.language,s.switchLanguage(t))}),t.bind("click",function(t){r.find(t.target).length>0||(s.showDropdown=!1,e.$apply())})}(),s.toggleMenu=function(e){s.showDropdown=!s.showDropdown,e.stopPropagation()},s.switchLanguage=function(e){n.use(e.code),s.selectedLanguage=e.language,a.setLanguageCode(e.code),i.setLanguage(e)}}angular.module("taskingManager").controller("languageSwitchController",["$scope","$document","$element","$translate","languageService","settingsService","userPreferencesService",t]).directive("languageSwitch",e)}(),function(){function e(){return{restrict:"EA",templateUrl:"app/components/project-chat/project-chat.html",controller:"projectChatController",controllerAs:"projectChatCtrl",scope:{projectId:"=projectId",projectAuthor:"=projectAuthor"},bindToController:!0}}function t(e,t,r,n,a,o,i){function s(){c.errorGetMessages=!1,o.getProjectChatMessages(c.projectId).then(function(e){c.messages=e.chat;for(var a=0;a<c.messages.length;a++)c.messages[a].message=o.formatUserNamesToLink(c.messages[a].message);n(function(){c.hasScrolled||(r.hash("bottom"),t(),c.hasScrolled=!0)},1e3)},function(e){c.messages=[],404!=e.status&&(c.errorGetMessages=!0)})}var c=this;c.projectId=0,c.author="",c.message="",c.messages=[],c.maxlengthComment=250,c.hasScrolled=!1,c.successMessageAdded=!1,c.errorMessageAdded=!1,c.errorGetMessages=!1,c.errorAddPMUsername=!1;var l=void 0;e.$watch("projectChatCtrl.projectId",function(e){c.projectId=e,c.projectId&&s()}),e.$watch("projectChatCtrl.projectAuthor",function(e){c.author=e}),l=a(function(){s()},1e4),e.$on("$routeChangeStart",function(){angular.isDefined(l)&&(a.cancel(l),l=void 0)}),c.searchUser=function(e){return i.searchUser(e).then(function(e){if(c.usernames=[],e.usernames)for(var t=0;t<e.usernames.length;t++)c.usernames.push({label:e.usernames[t]});return e.usernames},function(){})},c.formatUserTag=function(e){return"@["+e.label+"]"},c.addMessage=function(){c.successMessageAdded=!1,c.errorMessageAdded=!1,o.addProjectChatMessage(c.message,c.projectId).then(function(e){c.messages=e.chat;for(var r=0;r<c.messages.length;r++)c.messages[r].message=o.formatUserNamesToLink(c.messages[r].message);n(function(){t(["bottom"])},1e3),c.message="",c.successMessageAdded=!0},function(e){"404"!==e.status&&(c.errorMessageAdded=!0)})},c.messageProjectManager=function(){c.errorAddPMUsername=!1;var e="@["+c.author+"]";c.message.length+e.length<c.maxlengthComment?c.message+=e:c.errorAddPMUsername=!0}}angular.module("taskingManager").controller("projectChatController",["$scope","$anchorScroll","$location","$timeout","$interval","messageService","userService",t]).directive("projectChat",e)}(),function(){function e(){return{restrict:"EA",templateUrl:"app/components/popup/mapPopup.html",controller:"mapPopupController",controllerAs:"mapPopupCtrl",scope:{selectedFeature:"=selectedFeature"},bindToController:!0}}function t(e,t){var r=this;r.feature,r.projectDetails={},r.characterLimitShortDescription=100,e.$watch("mapPopupCtrl.selectedFeature",function(e){r.feature=e,r.projectDetails.projectId=e.projectId,r.projectDetails.projectName=e.name,r.projectDetails.mapperLevel=e.mapperLevel,r.projectDetails.organisationTag=e.organisationTag,
r.projectDetails.shortDescription=e.shortDescription,r.projectDetails.percentMapped=e.percentMapped,r.projectDetails.percentValidated=e.percentValidated,r.projectDetails.projectStatus=e.status}),r.close=function(){t.closePopup()}}angular.module("taskingManager").controller("mapPopupController",["$scope","projectMapService","mapService",t]).directive("mapPopup",e)}(),function(){function e(){return{restrict:"EA",templateUrl:"app/components/show-project-aois/showProjectAois.html",controller:"showProjectAoisController",controllerAs:"showProjectAoisCtrl",scope:{yourProjects:"="},bindToController:!0}}function t(e,t,r,n,a,o){function i(){var t=new ol.source.Vector({loader:function(e){s.errorLoadingExistingProjects=!1,t.clear();var a={bbox:n.transformExtentToLatLonString(e),createdByMe:s.yourProjects};r.getProjectsWithinBBOX(a).then(function(e){var r=n.getFeaturesFromGeoJSON(e);t.addFeatures(r)},function(){s.errorLoadingExistingProjects=!0})},strategy:ol.loadingstrategy.bbox});s.otherProjectVectorLayer=new ol.layer.Vector({source:t,style:function(e){var t=e.getProperties().projectStatus;return"DRAFT"===t?a.getStyleWithColour("blue"):"PUBLISHED"===t?a.getStyleWithColour("red"):a.getStyleWithColour("black")},maxResolution:s.otherProjectMaxResolution}),s.otherProjectVectorLayer.setZIndex(50),s.map.addLayer(s.otherProjectVectorLayer),s.otherProjectVectorLayer.setVisible(!1),s.map.on("moveend",function(){s.errorLoadingExistingProjects=!1,s.currentResolution=s.map.getView().getResolution(),e.$apply()})}var s=this;s.otherProjectVectorLayer=null,s.otherProjectMaxResolution=1250,s.currentResolution=0,s.errorLoadingExistingProjects=!1,function(){s.map=t.getOSMMap()}(),e.$watch("showProjectAoisCtrl.yourProjects",function(e){s.yourProjects=e,i(),o.initialise(s.map);o.addPopupOverlay(!1,!0),s.currentResolution=s.map.getView().getResolution()}),s.toggleOtherProjectAreasLayer=function(){s.otherProjectVectorLayer.getVisible()?(s.otherProjectVectorLayer.setVisible(!1),o.closePopup()):s.otherProjectVectorLayer.setVisible(!0)}}angular.module("taskingManager").controller("showProjectAoisController",["$scope","mapService","searchService","geospatialService","styleService","projectMapService",t]).directive("showProjectAois",e)}();